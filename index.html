<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>High-Quality Video Upload & Viewer</title>
<meta name="description" content="Upload, watch, share and comment on high quality MP4 videos.">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/x-icon" href="icon/Vibro.ico?v=1">
<link rel="shortcut icon" type="image/x-icon" href="icon/Vibro.ico?v=1">
<link rel="apple-touch-icon" href="icon/Vibro.ico?v=1">
<style>
body { font-family: 'Segoe UI', Arial, sans-serif; background: #121212; color: #fff; margin:0; padding:2rem; }
h1 { color:#fff; margin-bottom:1rem; }
#uploadSection, #videosSection { background:#1f1f1f; padding:1.5rem; border-radius:12px; margin-bottom:2rem; }
#uploadSection input,#uploadSection button,#searchInput { padding:0.75rem; margin:0.5rem 0; width:100%; border-radius:8px; border:none; font-size:1rem; }
#uploadSection button,#loadMoreBtn,.shareBtn,.new-comment button,#videoModal button { background-color:#0077cc; color:#fff; font-weight:bold; cursor:pointer; transition:0.3s; border:none; border-radius:6px; }
#uploadSection button:hover,#loadMoreBtn:hover,.shareBtn:hover,.new-comment button:hover,#videoModal button:hover { background-color:#005fa3; }
progress { width:100%; height:20px; margin-top:1rem; border-radius:10px; overflow:hidden; display:none; }
#result { margin-top:1rem; word-break:break-word; font-size:0.95rem; }
#totalVideos { margin-bottom:1rem; font-weight:bold; font-size:0.95rem; }
#videosList { display:flex; flex-direction:column; gap:2rem; }
.video-item { position:relative; border-radius:16px; overflow:hidden; background:#1f1f1f; cursor:pointer; transition:transform 0.2s ease,box-shadow 0.3s ease; width:100%; box-shadow:0 4px 12px rgba(0,0,0,0.5); display:flex; flex-direction:column; padding:1rem; }
.video-item:hover { transform:scale(1.02); box-shadow:0 10px 25px rgba(0,0,0,0.7); }
.video-item video { width:100%; height:auto; display:block; border-radius:12px; background-color:black; margin-bottom:0.5rem; }
.video-duration { position:absolute; bottom:8px; right:8px; background:rgba(0,0,0,0.7); color:#fff; padding:2px 6px; border-radius:6px; font-size:0.75rem; pointer-events:none; opacity:0; transition:opacity 0.2s; }
.user-info { display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem; }
.user-info img { width:36px; height:36px; border-radius:50%; object-fit:cover; }
.comment { background:#2a2a2a; padding:0.6rem; margin-top:0.5rem; border-radius:6px; }
.comment-user { font-weight:bold; font-size:0.85rem; display:flex; align-items:center; gap:0.5rem; }
.comment-text { font-size:0.85rem; margin-left:2rem; }
.new-comment { display:flex; gap:0.5rem; margin-top:0.5rem; }
.new-comment input { flex:1; padding:0.5rem; border-radius:6px; border:none; background:#2a2a2a; color:#fff; }
#videoModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); justify-content:center; align-items:center; z-index:999; }
#videoModal video { width:90%; max-height:95%; border-radius:12px; box-shadow:0 0 25px #000; }
</style>
</head>
<body>

<h1>Upload MP4 Video</h1>
<div id="uploadSection">
  <input type="file" id="videoFile" accept=".mp4,video/mp4">
  <input type="file" id="coverFile" accept="image/*">
  <input type="text" id="videoTitle" placeholder="Video title">
  <button id="uploadBtn">Upload</button>
  <progress id="progressBar" max="100"></progress>
  <div id="result"></div>
</div>

<h1>View Uploaded Videos</h1>
<div id="videosSection">
  <input type="text" id="searchInput" placeholder="Search by email, username, or filename">
  <div id="totalVideos"></div>
  <div id="videosList"></div>
  <button id="loadMoreBtn">Load More</button>
</div>

<div id="videoModal">
  <video id="modalVideo" controls></video>
  <button onclick="closeModal()">X</button>
</div>

<script>
let videosCache = [], displayedCount = 0, pageSize = 10;
let observer;
const isMobile = /iPhone|iPad|Android/i.test(navigator.userAgent);

// Modal functions
function openModal(url){ const m=document.getElementById('videoModal'), v=document.getElementById('modalVideo'); v.src=url; m.style.display='flex'; v.play(); }
function closeModal(){ const m=document.getElementById('videoModal'), v=document.getElementById('modalVideo'); v.pause(); v.src=''; m.style.display='none'; }

// Mobile scroll autoplay
function initObserver(){
  if(!isMobile) return;
  observer = new IntersectionObserver(entries=>{
    entries.forEach(entry=>{
      const v = entry.target;
      if(entry.isIntersecting){ v.play().catch(()=>{}); } 
      else { v.pause(); v.currentTime=0; }
    });
  }, { threshold: 0.7 });
}

// Upload video
document.getElementById('uploadBtn').addEventListener('click', ()=>{
  const videoFile=document.getElementById('videoFile').files[0];
  const coverFile=document.getElementById('coverFile').files[0];
  const title=document.getElementById('videoTitle').value.trim();
  if(!videoFile||!coverFile||!title){ alert('All fields required'); return; }

  const progressBar=document.getElementById('progressBar'); progressBar.style.display='block'; progressBar.value=0;
  const formData=new FormData();
  formData.append('video',videoFile);
  formData.append('cover',coverFile);
  formData.append('title',title);

  const xhr=new XMLHttpRequest();
  xhr.open('POST','/api/upload-video',true);
  xhr.withCredentials=true;
  xhr.upload.onprogress=e=>{ if(e.lengthComputable) progressBar.value=(e.loaded/e.total)*100; };
  xhr.onload=()=>{ progressBar.style.display='none'; if(xhr.status>=200 && xhr.status<300) loadVideos(true); else alert('Upload failed: '+xhr.responseText); };
  xhr.onerror=()=>{ progressBar.style.display='none'; alert('Upload failed: Network error'); };
  xhr.send(formData);
});

// Render videos
function renderVideos(videos){
  const list=document.getElementById('videosList');
  const searchTerm=document.getElementById('searchInput').value.toLowerCase();
  const filtered=videos.filter(v=> (v.user?.email||'').toLowerCase().includes(searchTerm) || (v.user?.username||'').toLowerCase().includes(searchTerm) || (v.name||'').toLowerCase().includes(searchTerm));
  const batch=filtered.slice(displayedCount,displayedCount+pageSize);

  batch.forEach(video=>{
    const div=document.createElement('div'); div.className='video-item';
    div.innerHTML=`
      <div class="user-info">
        <img src="${video.user?.avatar_url||'https://via.placeholder.com/36'}">
        <span>${video.user?.username||'User'} (${video.user?.email||''})</span>
      </div>
      <div style="position:relative;">
        <video muted preload="metadata" poster="${video.coverUrl}" playsinline>
          <source src="${video.videoUrl}" type="video/mp4">
        </video>
        <span class="video-duration">--:--</span>
      </div>
      <button class="shareBtn">Share Video</button>
      <div class="commentsSection"></div>
      <div class="new-comment">
        <input type="text" placeholder="Write a comment...">
        <button>Post</button>
      </div>
    `;
    list.appendChild(div);

    const vid = div.querySelector('video'), dur = div.querySelector('.video-duration');
    vid.addEventListener('loadedmetadata',()=>{ dur.textContent=`${Math.floor(vid.duration/60)}:${Math.floor(vid.duration%60).toString().padStart(2,'0')}`; });

    if(!isMobile){
      div.addEventListener('mouseenter',()=>{ vid.play(); dur.style.opacity='1'; });
      div.addEventListener('mouseleave',()=>{ vid.pause(); vid.currentTime=0; dur.style.opacity='0'; });
      vid.addEventListener('click',()=>openModal(video.videoUrl));
    } else { if(observer) observer.observe(vid); }

    div.querySelector('.shareBtn').addEventListener('click',()=>{ navigator.clipboard.writeText(video.videoUrl).then(()=>alert('Copied!')).catch(()=>alert('Failed.')); });

// Render existing comments safely
const commentsDiv = div.querySelector('.commentsSection');
(video.comments || []).forEach(c => {
  const username = (c.user && (c.user.username || c.user.name)) || 'User';
  const avatar = (c.user && c.user.avatar_url) || 'https://via.placeholder.com/24';
  
  const cDiv = document.createElement('div');
  cDiv.className = 'comment';
  cDiv.innerHTML = `
    <div class="comment-user">
      <img src="${avatar}">
      <span>${username}</span>
    </div>
    <div class="comment-text">${c.text}</div>
  `;
  commentsDiv.appendChild(cDiv);
});

    // Add new comment
    const newInput=div.querySelector('.new-comment input'), newBtn=div.querySelector('.new-comment button');
    newBtn.addEventListener('click', async () => {
  const text = newInput.value.trim();
  if (!text) return;
  try {
    const res = await fetch(`/api/view-videos?videoId=${video.id}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ text })
    });
    if (res.ok) {
      const c = await res.json();
      const username = c.user?.username || c.user?.name || 'Anonymous';
      const avatar = c.user?.avatar_url || 'https://via.placeholder.com/24';

      const cDiv = document.createElement('div');
      cDiv.className = 'comment';
      cDiv.innerHTML = `
        <div class="comment-user">
          <img src="${avatar}">
          <span>${username}</span>
        </div>
        <div class="comment-text">${c.text}</div>
      `;
      commentsDiv.appendChild(cDiv);
      newInput.value = '';
    } else alert('Failed to post comment');
  } catch (err) {
    alert('Error: ' + err.message);
  }
});

  displayedCount += batch.length;
  document.getElementById('totalVideos').innerText=`Showing ${displayedCount} of ${filtered.length} videos`;
  document.getElementById('loadMoreBtn').style.display=(displayedCount<filtered.length)?'block':'none';
}

// Load videos
async function loadVideos(reset=false){
  if(reset){ displayedCount=0; document.getElementById('videosList').innerHTML=''; }
  try{
    const res=await fetch('/api/view-videos',{method:'GET',credentials:'include'});
    if(!res.ok){ alert('Failed: '+await res.text()); return; }
    videosCache=await res.json();
    if(!observer) initObserver();
    renderVideos(videosCache);
  }catch(err){ alert('Failed: '+err.message); }
}

window.addEventListener('DOMContentLoaded',()=>loadVideos());
document.getElementById('loadMoreBtn').addEventListener('click',()=>renderVideos(videosCache));
document.getElementById('searchInput').addEventListener('input',()=>{ displayedCount=0; document.getElementById('videosList').innerHTML=''; renderVideos(videosCache); });
</script>
</body>
</html>
