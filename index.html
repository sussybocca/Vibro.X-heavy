<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Vibro-X Ultimate | Complete Immersive Video Platform</title>
<meta name="description" content="Ultimate platform combining Vibro.x video sharing with 500+ animations, 40 cursors, 3D avatars, physics, and immersive effects">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/x-icon" href="/vibro.png?v=1">
<link rel="shortcut icon" type="image/x-icon" href="/vibro.png?v=1">
<link rel="apple-touch-icon" href="/vibro.png?v=1">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Poppins:wght@100;200;300;400;500;600;700;800;900&family=Exo+2:wght@300;400;600&family=Audiowide&family=Press+Start+2P&family=Major+Mono+Display&display=swap" rel="stylesheet">
<!-- Three.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<!-- GLTF Loader -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.min.js"></script>
<!-- Orbit Controls -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
<!-- Particles.js -->
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<!-- Howler.js for Audio -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
<style>
/* ============ COMBINED ROOT VARIABLES ============ */
:root {
    /* Vibro.x Colors */
    --primary: #ff0000;
    --primary-dark: #cc0000;
    --primary-light: #ff3333;
    --secondary: #065fd4;
    --secondary-light: #4d8eff;
    --accent-1: #ff00ff;
    --accent-2: #00ffff;
    --accent-3: #ffff00;
    --accent-4: #00ff00;
    --dark-bg: #0a0a0a;
    --darker-bg: #050505;
    --dark-surface: #151515;
    --dark-surface-light: #222222;
    --dark-surface-hover: #333333;
    --text-primary: #ffffff;
    --text-secondary: #cccccc;
    --text-tertiary: #888888;
    --border-color: #404040;
    --success: #00ff88;
    --danger: #ff3860;
    --warning: #ffdd40;
    --info: #2be2ff;
    
    /* Experience.X Colors */
    --ex-primary: #6c5ce7;
    --ex-primary-dark: #5649c4;
    --ex-secondary: #00cec9;
    --ex-accent: #fd79a8;
    --ex-tech-blue: #0984e3;
    --ex-tech-green: #00b894;
    --ex-tech-purple: #a29bfe;
    --ex-tech-orange: #e17055;
    --ex-tech-yellow: #fdcb6e;
    --ex-tech-red: #ff7675;
    --ex-cyberpunk-pink: #ff00ff;
    --ex-cyberpunk-blue: #00ffff;
    --ex-matrix-green: #00ff41;
    
    /* Combined Effects */
    --neon-glow: 0 0 10px, 0 0 20px, 0 0 30px, 0 0 40px;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.8);
    --shadow-md: 0 4px 20px rgba(0,0,0,0.9);
    --shadow-lg: 0 10px 40px rgba(0,0,0,1);
    --transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    --transition-slow: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    --border-radius: 16px;
    --border-radius-sm: 10px;
    --border-radius-full: 9999px;
    --header-height: 70px;
}

/* ============ BACKGROUND & PARTICLE EFFECTS ============ */
#particles-js {
    position: fixed;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    z-index: -1000;
    pointer-events: none;
}

.background-effects {
    position: fixed;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    z-index: -999;
    overflow: hidden;
    pointer-events: none;
}

.gradient-bg {
    position: absolute;
    width: 200%;
    height: 200%;
    top: -50%;
    left: -50%;
    background: 
        radial-gradient(circle at 20% 30%, rgba(255, 0, 0, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(6, 95, 212, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(0, 255, 255, 0.1) 0%, transparent 50%);
    animation: rotateGradient 60s linear infinite;
}

.floating-element {
    position: absolute;
    border-radius: 50%;
    background: radial-gradient(circle, var(--primary) 0%, transparent 70%);
    filter: blur(40px);
    opacity: 0.1;
    z-index: -1;
    animation: floatAround 20s infinite linear;
}

.matrix-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: -2;
    opacity: 0.05;
}

/* ============ ADVANCED CURSOR SYSTEM ============ */
.cursor-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    pointer-events: none;
    z-index: 999999;
    overflow: hidden;
}

.cursor-dot {
    position: absolute;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--primary);
    pointer-events: none;
    z-index: 999999;
    transform: translate(-50%, -50%);
    transition: transform 0.1s linear, width 0.3s, height 0.3s, background-color 0.3s;
    mix-blend-mode: difference;
    filter: drop-shadow(0 0 5px currentColor);
}

.cursor-outline {
    position: absolute;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid var(--primary);
    pointer-events: none;
    z-index: 999998;
    transform: translate(-50%, -50%);
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    filter: drop-shadow(0 0 8px var(--primary));
}

.cursor-trail {
    position: absolute;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--primary);
    pointer-events: none;
    z-index: 999997;
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.5);
}

.trail-1 { animation: trailFade 0.6s ease-out forwards; }
.trail-2 { animation: trailFade 0.5s ease-out 0.05s forwards; }
.trail-3 { animation: trailFade 0.4s ease-out 0.1s forwards; }
.trail-4 { animation: trailFade 0.3s ease-out 0.15s forwards; }
.trail-5 { animation: trailFade 0.2s ease-out 0.2s forwards; }

/* ============ ALL CURSOR EFFECTS ============ */
.cursor-dot.effect-ripple { animation: rippleEffect 0.6s ease-out; }
.cursor-dot.effect-pulse { animation: pulseEffect 0.8s ease-in-out infinite; }
.cursor-dot.effect-spin { animation: spinEffect 1s linear infinite; }
.cursor-dot.effect-bounce { animation: bounceEffect 0.5s ease infinite alternate; }
.cursor-dot.effect-shake { animation: shakeEffect 0.3s ease-in-out infinite; }
.cursor-dot.effect-color-cycle { animation: colorCycle 3s linear infinite; }
.cursor-dot.effect-rainbow { 
    background: linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff, #ff00ff);
    background-size: 400% 400%;
    animation: rainbowEffect 3s linear infinite;
}
.cursor-outline.effect-expand { animation: expandEffect 0.8s ease-out infinite alternate; }
.cursor-outline.effect-rotate { animation: rotateEffect 2s linear infinite; }
.cursor-outline.effect-wave { animation: waveEffect 1.5s ease-in-out infinite; }
.cursor-outline.effect-dash { border-style: dashed; animation: dashRotate 10s linear infinite; }

.cursor-dot.hover-button { width: 16px; height: 16px; background: var(--accent-1); animation: none; }
.cursor-dot.hover-video { width: 24px; height: 24px; background: transparent; border: 3px solid var(--accent-2); animation: spinEffect 1s linear infinite; }
.cursor-dot.hover-text { width: 4px; height: 24px; border-radius: 2px; background: var(--accent-3); animation: pulseEffect 1s ease-in-out infinite; }
.cursor-dot.hover-input { width: 20px; height: 20px; background: var(--accent-4); border-radius: 5px; animation: bounceEffect 0.5s ease infinite alternate; }
.cursor-dot.hover-danger { width: 12px; height: 12px; background: var(--danger); animation: shakeEffect 0.3s ease-in-out infinite; }
.cursor-dot.hover-success { width: 16px; height: 16px; background: var(--success); animation: pulseEffect 0.8s ease-in-out infinite; }
.cursor-outline.hover-button { border-color: var(--accent-1); width: 60px; height: 60px; animation: expandEffect 1s ease-out infinite alternate; }
.cursor-outline.hover-video { border-color: var(--accent-2); width: 80px; height: 80px; animation: waveEffect 1.5s ease-in-out infinite; }

/* ============ CURSOR THEMES ============ */
body.cursor-tech .cursor-dot { background: var(--ex-tech-blue); }
body.cursor-tech .cursor-outline { border-color: var(--ex-tech-blue); }
body.cursor-game .cursor-dot { background: var(--accent-3); }
body.cursor-game .cursor-outline { border-color: var(--accent-3); border-style: dashed; }
body.cursor-neon .cursor-dot { background: var(--ex-cyberpunk-pink); animation: neonPulse 1s infinite; }
body.cursor-neon .cursor-outline { border-color: var(--ex-cyberpunk-pink); box-shadow: 0 0 20px var(--ex-cyberpunk-pink); }
body.cursor-matrix .cursor-dot { background: var(--ex-matrix-green); }
body.cursor-matrix .cursor-outline { border-color: var(--ex-matrix-green); box-shadow: 0 0 15px var(--ex-matrix-green); }
body.cursor-hologram .cursor-dot { background: transparent; border: 2px solid var(--ex-tech-purple); }
body.cursor-hologram .cursor-outline { border-color: var(--ex-tech-purple); opacity: 0.3; }

/* ============ BASE STYLES ============ */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    cursor: none !important;
    user-select: none;
}

body {
    font-family: 'Inter', sans-serif;
    background-color: var(--darker-bg);
    color: var(--text-primary);
    overflow-x: hidden;
    min-height: 100vh;
}

/* ============ HEADER ============ */
.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: var(--header-height);
    background: rgba(15, 15, 15, 0.95);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    padding: 0 24px;
    z-index: 10000;
    gap: 32px;
    transform: translateY(0);
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), background 0.5s ease;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.header.scrolled {
    background: rgba(10, 10, 10, 0.98);
    height: 60px;
    backdrop-filter: blur(30px);
    box-shadow: 0 5px 20px rgba(255, 0, 0, 0.2);
}

.header.hidden {
    transform: translateY(-100%);
}

.logo {
    display: flex;
    align-items: center;
    gap: 12px;
    font-family: 'Orbitron', sans-serif;
    font-weight: 900;
    font-size: 28px;
    color: var(--text-primary);
    text-decoration: none;
    transition: var(--transition);
    position: relative;
    text-transform: uppercase;
    letter-spacing: 2px;
    background: linear-gradient(45deg, var(--primary), var(--accent-1), var(--accent-2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: logoGlow 3s ease-in-out infinite alternate;
}

.logo-icon {
    font-size: 32px;
    color: var(--primary);
    animation: logoSpin 10s linear infinite;
    filter: drop-shadow(0 0 10px var(--primary));
}

/* ============ SEARCH BAR ============ */
.search-container {
    flex: 1;
    max-width: 700px;
    position: relative;
}

.search-bar {
    display: flex;
    height: 48px;
    border-radius: var(--border-radius-full);
    overflow: hidden;
    border: 2px solid transparent;
    background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
    backdrop-filter: blur(10px);
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    position: relative;
    box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
}

.search-bar::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, var(--primary), var(--secondary), var(--accent-2));
    border-radius: var(--border-radius-full);
    z-index: -1;
    opacity: 0;
    transition: opacity 0.4s ease;
}

.search-bar:focus-within {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(255, 0, 0, 0.3);
}

.search-bar:focus-within::before {
    opacity: 1;
}

.search-input {
    flex: 1;
    padding: 0 24px;
    background: transparent;
    border: none;
    color: var(--text-primary);
    font-size: 16px;
    font-family: 'Poppins', sans-serif;
    font-weight: 400;
    outline: none;
    transition: var(--transition);
    letter-spacing: 0.5px;
}

.search-input::placeholder {
    color: var(--text-tertiary);
    font-style: italic;
}

.search-button {
    width: 80px;
    background: linear-gradient(45deg, var(--primary), var(--primary-dark));
    border: none;
    color: white;
    cursor: none;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    font-size: 18px;
}

.search-button::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.search-button:hover::before {
    width: 300px;
    height: 300px;
}

.search-button:hover {
    background: linear-gradient(45deg, var(--primary-light), var(--primary));
    transform: scale(1.05);
    box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
}

/* ============ UPLOAD BUTTON ============ */
.upload-btn {
    background: linear-gradient(45deg, var(--primary), var(--accent-1));
    color: white;
    border: none;
    padding: 12px 28px;
    border-radius: var(--border-radius-full);
    font-weight: 700;
    font-family: 'Rajdhani', sans-serif;
    font-size: 16px;
    cursor: none;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    letter-spacing: 1px;
    text-transform: uppercase;
    box-shadow: 0 5px 15px rgba(255, 0, 0, 0.3);
}

.upload-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.7s ease;
}

.upload-btn:hover::before {
    left: 100%;
}

.upload-btn:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 15px 35px rgba(255, 0, 0, 0.5),
                inset 0 0 20px rgba(255, 255, 255, 0.2);
    letter-spacing: 2px;
}

/* ============ USER AVATAR ============ */
.user-avatar {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    cursor: none;
    border: 3px solid transparent;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    object-fit: cover;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    position: relative;
    background: linear-gradient(45deg, var(--primary), var(--secondary));
    padding: 2px;
}

.user-avatar:hover {
    border-color: var(--primary);
    transform: scale(1.15) rotate(5deg);
    box-shadow: 0 0 30px var(--primary),
                inset 0 0 20px rgba(255, 255, 255, 0.2);
}

/* ============ DROPDOWN ============ */
.user-dropdown {
    position: absolute;
    top: calc(100% + 10px);
    right: 0;
    width: 280px;
    background: rgba(20, 20, 20, 0.95);
    backdrop-filter: blur(30px);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg),
                0 0 50px rgba(255, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: none;
    z-index: 10001;
    overflow: hidden;
    transform-origin: top right;
    animation: dropdownAppear 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.dropdown-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 24px;
    color: var(--text-primary);
    text-decoration: none;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    cursor: none;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    font-size: 15px;
    font-family: 'Poppins', sans-serif;
    font-weight: 500;
    position: relative;
    overflow: hidden;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

/* ============ MAIN CONTAINER ============ */
.main-container {
    display: flex;
    margin-top: var(--header-height);
    min-height: calc(100vh - var(--header-height));
    position: relative;
    overflow: hidden;
}

/* ============ SIDEBAR ============ */
.sidebar {
    width: 280px;
    background: rgba(20, 20, 20, 0.9);
    backdrop-filter: blur(20px);
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    padding: 24px 0;
    position: fixed;
    top: var(--header-height);
    left: 0;
    bottom: 0;
    overflow-y: auto;
    z-index: 9999;
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5);
}

.sidebar-item {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 18px 32px;
    color: var(--text-primary);
    text-decoration: none;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    cursor: none;
    border-radius: 0;
    margin: 0;
    position: relative;
    overflow: hidden;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 600;
    font-size: 16px;
    letter-spacing: 1px;
    text-transform: uppercase;
}

.sidebar-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 6px;
    background: linear-gradient(to bottom, var(--primary), var(--accent-1));
    transform: translateX(-100%);
    transition: transform 0.4s ease;
}

.sidebar-item:hover {
    background: rgba(255, 255, 255, 0.05);
    padding-left: 40px;
    letter-spacing: 2px;
}

.sidebar-item:hover::before {
    transform: translateX(0);
}

.sidebar-item.active {
    background: rgba(255, 0, 0, 0.15);
    color: var(--primary);
    padding-left: 40px;
    text-shadow: 0 0 10px var(--primary);
}

.sidebar-item.active::before {
    transform: translateX(0);
}

/* ============ MAIN CONTENT ============ */
.main-content {
    flex: 1;
    margin-left: 280px;
    padding: 32px;
    transition: margin-left 0.5s ease;
    position: relative;
    overflow: hidden;
}

/* ============ UPLOAD CONTAINER ============ */
.upload-container {
    max-width: 900px;
    margin: 0 auto;
    background: rgba(25, 25, 25, 0.8);
    backdrop-filter: blur(30px);
    border-radius: var(--border-radius);
    padding: 48px;
    box-shadow: var(--shadow-lg),
                0 0 60px rgba(255, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.1);
    animation: slideUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275),
               containerGlow 3s ease-in-out infinite alternate;
    position: relative;
    overflow: hidden;
}

.upload-container::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, var(--primary), var(--secondary), var(--accent-1), var(--accent-2));
    border-radius: calc(var(--border-radius) + 2px);
    z-index: -1;
    opacity: 0.3;
    filter: blur(20px);
    animation: borderGlow 4s linear infinite;
}

/* ============ VIDEO CARDS ============ */
.videos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
    gap: 32px;
    margin-top: 32px;
}

.video-card {
    background: rgba(30, 30, 30, 0.8);
    backdrop-filter: blur(20px);
    border-radius: var(--border-radius);
    overflow: hidden;
    transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    cursor: none;
    border: 1px solid rgba(255, 255, 255, 0.1);
    position: relative;
    transform-style: preserve-3d;
    perspective: 1000px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    animation: cardAppear 0.6s ease backwards;
}

.video-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent 30%, rgba(255, 0, 0, 0.05) 50%, transparent 70%);
    opacity: 0;
    transition: opacity 0.6s ease;
    z-index: 1;
}

.video-card::after {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, var(--primary), var(--secondary), var(--accent-1));
    border-radius: calc(var(--border-radius) + 2px);
    z-index: -1;
    opacity: 0;
    transition: opacity 0.6s ease;
    filter: blur(20px);
}

.video-card:hover {
    transform: translateY(-15px) scale(1.05) rotateX(5deg) rotateY(5deg);
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.7),
                0 0 50px rgba(255, 0, 0, 0.3);
    border-color: var(--primary);
    z-index: 100;
}

.video-card:hover::before {
    opacity: 1;
    animation: shimmer 2s linear infinite;
}

.video-card:hover::after {
    opacity: 0.5;
}

.video-thumbnail {
    position: relative;
    aspect-ratio: 16 / 9;
    overflow: hidden;
    transform-style: preserve-3d;
}

.video-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    transform: translateZ(20px);
}

.video-card:hover .video-thumbnail img {
    transform: scale(1.2) translateZ(30px);
    filter: brightness(1.2) contrast(1.1) saturate(1.3);
}

.video-duration {
    position: absolute;
    bottom: 12px;
    right: 12px;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 8px 12px;
    border-radius: var(--border-radius-sm);
    font-size: 13px;
    font-weight: 700;
    font-family: 'Orbitron', sans-serif;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transform: translateZ(30px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    transition: all 0.4s ease;
}

.video-info {
    padding: 20px;
    display: flex;
    gap: 16px;
    background: rgba(20, 20, 20, 0.9);
    backdrop-filter: blur(10px);
    transform-style: preserve-3d;
}

.channel-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
    border: 3px solid transparent;
    transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    transform: translateZ(20px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    position: relative;
}

.video-content {
    flex: 1;
    min-width: 0;
    transform: translateZ(20px);
}

.video-title {
    font-weight: 700;
    font-family: 'Poppins', sans-serif;
    font-size: 17px;
    margin-bottom: 10px;
    line-height: 1.4;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    transition: all 0.4s ease;
    color: var(--text-primary);
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
}

.channel-name {
    font-size: 14px;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
    transition: all 0.4s ease;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.video-stats {
    font-size: 13px;
    font-family: 'Orbitron', sans-serif;
    color: var(--text-tertiary);
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    font-weight: 500;
    letter-spacing: 1px;
    transform: translateZ(15px);
}

/* ============ VIDEO MODAL ============ */
.video-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.98);
    z-index: 20000;
    display: none;
    animation: modalFadeIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    backdrop-filter: blur(50px);
}

.video-modal.show {
    display: flex;
}

.video-modal::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at center, rgba(255,0,0,0.1) 0%, transparent 70%);
    animation: modalBgPulse 4s ease-in-out infinite alternate;
}

.modal-content {
    max-width: 1800px;
    margin: 0 auto;
    padding: 32px;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    position: relative;
    z-index: 1;
}

.modal-header {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 24px;
    animation: slideDown 0.6s ease 0.3s backwards;
}

.close-modal {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: var(--text-primary);
    width: 56px;
    height: 56px;
    border-radius: 50%;
    cursor: none;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
    border: 2px solid transparent;
}

.modal-body {
    display: flex;
    gap: 32px;
    flex: 1;
    animation: modalBodyAppear 0.6s ease 0.4s backwards;
}

.video-player-container {
    flex: 3;
    min-width: 0;
    display: flex;
    flex-direction: column;
}

.video-player {
    width: 100%;
    aspect-ratio: 16 / 9;
    background: #000;
    border-radius: var(--border-radius);
    overflow: hidden;
    flex-shrink: 0;
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.8),
                0 0 80px rgba(255, 0, 0, 0.3);
    transform-style: preserve-3d;
    transform: perspective(1000px) rotateX(0deg);
    transition: transform 0.6s ease;
    border: 2px solid rgba(255, 255, 255, 0.1);
    position: relative;
}

/* Avatar Overlay in Video Player */
.avatar-overlay {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 150px;
    height: 200px;
    z-index: 10;
    pointer-events: none;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 10px;
    overflow: hidden;
    backdrop-filter: blur(10px);
    border: 2px solid var(--primary);
    opacity: 0;
    transition: opacity 0.5s ease;
}

.avatar-overlay.visible {
    opacity: 1;
}

#videoAvatarCanvas {
    width: 100%;
    height: 100%;
    background: transparent;
}

.video-actions-bar {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 20px;
    position: relative;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 28px;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid transparent;
    border-radius: var(--border-radius-full);
    color: var(--text-primary);
    cursor: none;
    transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 15px;
    letter-spacing: 1px;
    text-transform: uppercase;
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
}

.action-btn.liked {
    background: rgba(255, 0, 0, 0.2);
    color: var(--primary);
    border-color: var(--primary);
    animation: likePulse 1s ease-in-out infinite alternate;
}

/* ============ COMMENTS SECTION ============ */
.comments-section {
    background: rgba(25, 25, 25, 0.8);
    backdrop-filter: blur(30px);
    border-radius: var(--border-radius);
    padding: 32px;
    margin-top: 24px;
    flex: 1;
    min-height: 500px;
    max-height: 600px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border-left: 6px solid var(--info);
    animation: commentsSlideIn 0.6s ease 0.5s backwards;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.comments-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    padding-bottom: 16px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
}

.comment-form {
    display: flex;
    gap: 20px;
    margin-bottom: 32px;
    padding: 24px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: var(--border-radius);
    border: 2px solid rgba(255, 255, 255, 0.1);
    transition: all 0.4s ease;
}

.comment-avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
    border: 3px solid transparent;
    transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.comment-input-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.comment-input {
    width: 100%;
    padding: 20px 24px;
    background: rgba(255, 255, 255, 0.08);
    border: 2px solid transparent;
    border-radius: var(--border-radius);
    color: var(--text-primary);
    font-size: 16px;
    font-family: 'Poppins', sans-serif;
    outline: none;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    backdrop-filter: blur(10px);
    resize: vertical;
    min-height: 120px;
}

.comment-submit {
    background: linear-gradient(45deg, var(--info), var(--accent-2));
    color: white;
    border: none;
    padding: 16px 32px;
    border-radius: var(--border-radius-full);
    font-weight: 700;
    font-family: 'Rajdhani', sans-serif;
    font-size: 16px;
    cursor: none;
    transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    align-self: flex-end;
    min-width: 140px;
    position: relative;
    overflow: hidden;
    letter-spacing: 1px;
    text-transform: uppercase;
    box-shadow: 0 10px 30px rgba(52, 152, 219, 0.4);
}

.comments-list {
    flex: 1;
    overflow-y: auto;
    padding-right: 12px;
    animation: commentsListAppear 0.6s ease 0.6s backwards;
}

.comment-item {
    display: flex;
    gap: 20px;
    padding: 24px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    animation: commentSlideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) backwards;
    transform-style: preserve-3d;
    position: relative;
    transition: all 0.4s ease;
    border-radius: var(--border-radius-sm);
    margin-bottom: 12px;
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(10px);
}

.comment-content {
    flex: 1;
    transform-style: preserve-3d;
}

.comment-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
    flex-wrap: wrap;
}

.comment-author {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 16px;
    color: var(--text-primary);
    transition: all 0.4s ease;
    letter-spacing: 1px;
    position: relative;
    display: inline-block;
}

.comment-time {
    color: var(--text-tertiary);
    font-size: 13px;
    font-family: 'Orbitron', sans-serif;
    font-weight: 500;
    letter-spacing: 1px;
    transition: all 0.4s ease;
}

.comment-text {
    font-size: 15px;
    font-family: 'Poppins', sans-serif;
    line-height: 1.6;
    margin-bottom: 20px;
    color: var(--text-primary);
    word-break: break-word;
    transition: all 0.4s ease;
    transform: translateZ(10px);
}

.comment-actions {
    display: flex;
    gap: 24px;
    align-items: center;
    margin-top: 20px;
    transform: translateZ(15px);
}

.comment-like {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid transparent;
    color: var(--text-secondary);
    cursor: none;
    font-size: 13px;
    padding: 10px 20px;
    border-radius: var(--border-radius-full);
    transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    font-family: 'Rajdhani', sans-serif;
    font-weight: 600;
    letter-spacing: 1px;
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(5px);
}

.comment-like.liked {
    background: rgba(52, 152, 219, 0.2);
    color: var(--info);
    border-color: var(--info);
    animation: commentLikePulse 1s ease-in-out infinite alternate;
}

/* ============ CUSTOMIZATION PANEL ============ */
.customization-panel {
    position: fixed;
    top: var(--header-height);
    right: -400px;
    width: 380px;
    height: calc(100vh - var(--header-height));
    background: rgba(10, 10, 20, 0.95);
    backdrop-filter: blur(20px);
    border-left: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 9998;
    transition: right 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    overflow-y: auto;
    padding: 24px;
    box-shadow: -10px 0 40px rgba(0, 0, 0, 0.5);
}

.customization-panel.active {
    right: 0;
}

.customization-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
    padding-bottom: 16px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
}

.customization-section {
    margin-bottom: 32px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: var(--border-radius);
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.section-title {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    color: var(--secondary);
    font-family: 'Orbitron', sans-serif;
}

/* ============ 3D AVATAR VIEWER ============ */
.avatar-viewer-container {
    width: 100%;
    height: 400px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: var(--border-radius);
    border: 1px solid rgba(108, 92, 231, 0.3);
    position: relative;
    overflow: hidden;
    margin-bottom: 20px;
}

.avatar-controls {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
    background: rgba(0, 0, 0, 0.7);
    padding: 15px;
    border-radius: var(--border-radius);
    border: 1px solid rgba(108, 92, 231, 0.3);
    z-index: 10;
}

.avatar-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(108, 92, 231, 0.3);
    border: 1px solid var(--ex-primary);
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.avatar-btn:hover {
    background: var(--ex-primary);
    transform: scale(1.1);
}

/* ============ CURSOR SELECTOR ============ */
.cursor-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 15px;
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: var(--border-radius-sm);
}

.cursor-option {
    width: 80px;
    height: 80px;
    background: rgba(18, 18, 37, 0.8);
    border: 1px solid rgba(108, 92, 231, 0.3);
    border-radius: var(--border-radius-sm);
    padding: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.cursor-option:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(108, 92, 231, 0.3);
}

.cursor-option.selected {
    background: rgba(108, 92, 231, 0.3);
    border-color: var(--ex-primary);
    box-shadow: 0 0 15px rgba(108, 92, 231, 0.5);
    transform: scale(1.05);
}

/* ============ EFFECTS SELECTOR ============ */
.effects-presets {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: var(--border-radius-sm);
}

.preset-btn {
    background: rgba(18, 18, 37, 0.8);
    border: 1px solid rgba(108, 92, 231, 0.3);
    border-radius: var(--border-radius-sm);
    padding: 15px;
    color: var(--light);
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.preset-btn:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(108, 92, 231, 0.3);
}

.preset-btn.active {
    background: rgba(108, 92, 231, 0.3);
    border-color: var(--ex-primary);
    box-shadow: 0 0 15px rgba(108, 92, 231, 0.5);
    transform: scale(1.05);
}

/* ============ SOUND BOARD ============ */
.sound-board {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 15px;
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: var(--border-radius-sm);
}

.sound-pad {
    background: var(--dark-surface);
    border-radius: var(--border-radius-sm);
    padding: 15px 10px;
    text-align: center;
    border: 1px solid rgba(108, 92, 231, 0.3);
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.sound-pad:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(108, 92, 231, 0.3);
}

.sound-pad.active {
    background: var(--ex-primary);
    transform: scale(0.95);
}

/* ============ PHYSICS CONTROLS ============ */
.physics-controls {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: var(--border-radius-sm);
}

.physics-control {
    background: rgba(18, 18, 37, 0.8);
    border: 1px solid rgba(108, 92, 231, 0.3);
    border-radius: var(--border-radius-sm);
    padding: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.physics-control:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(108, 92, 231, 0.3);
}

.physics-control.active {
    background: rgba(108, 92, 231, 0.3);
    border-color: var(--ex-primary);
    box-shadow: 0 0 15px rgba(108, 92, 231, 0.5);
}

/* ============ TOGGLE BUTTONS ============ */
.toggle-group {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: var(--border-radius-sm);
    margin-bottom: 10px;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 30px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(108, 92, 231, 0.3);
    transition: .4s;
    border-radius: 34px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: var(--ex-secondary);
}

input:checked + .toggle-slider:before {
    transform: translateX(30px);
}

/* ============ SLIDERS ============ */
.slider-container {
    margin: 20px 0;
}

.slider-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.slider-label {
    font-size: 14px;
    color: var(--text-secondary);
}

.slider-value {
    font-family: 'Orbitron', sans-serif;
    color: var(--ex-tech-blue);
    font-size: 14px;
}

.slider {
    -webkit-appearance: none;
    width: 100%;
    height: 10px;
    border-radius: 5px;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    outline: none;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    background: white;
    cursor: pointer;
    border: 3px solid var(--primary);
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
}

.slider::-webkit-slider-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 0 15px var(--primary);
}

/* ============ NOTIFICATION SYSTEM ============ */
.notification {
    position: fixed;
    top: 30px;
    right: 30px;
    padding: 24px 32px;
    border-radius: var(--border-radius);
    background: rgba(25, 25, 25, 0.95);
    backdrop-filter: blur(30px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: var(--shadow-lg),
                0 0 50px rgba(255, 0, 0, 0.3);
    z-index: 30000;
    display: none;
    align-items: center;
    gap: 20px;
    max-width: 450px;
    animation: notificationSlideIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275),
               notificationGlow 2s ease-in-out infinite alternate;
    transform-origin: top right;
}

.notification.show {
    display: flex;
}

.notification.success {
    border-left: 6px solid var(--success);
    box-shadow: var(--shadow-lg),
                0 0 50px rgba(46, 204, 113, 0.3);
}

.notification.error {
    border-left: 6px solid var(--danger);
    box-shadow: var(--shadow-lg),
                0 0 50px rgba(231, 76, 60, 0.3);
}

.notification.info {
    border-left: 6px solid var(--info);
    box-shadow: var(--shadow-lg),
                0 0 50px rgba(52, 152, 219, 0.3);
}

.notification.warning {
    border-left: 6px solid var(--warning);
    box-shadow: var(--shadow-lg),
                0 0 50px rgba(243, 156, 18, 0.3);
}

/* ============ LOADING EFFECTS ============ */
.loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 80px;
    gap: 32px;
    position: relative;
}

.loading-spinner {
    width: 80px;
    height: 80px;
    border: 5px solid transparent;
    border-top-color: var(--primary);
    border-right-color: var(--secondary);
    border-bottom-color: var(--accent-1);
    border-left-color: var(--accent-2);
    border-radius: 50%;
    animation: spin 1.5s linear infinite,
               colorShift 3s linear infinite;
    position: relative;
    box-shadow: 0 0 40px rgba(255, 0, 0, 0.3);
}

.loading-spinner::before {
    content: '';
    position: absolute;
    top: -10px;
    left: -10px;
    right: -10px;
    bottom: -10px;
    border: 5px solid transparent;
    border-radius: 50%;
    animation: spin 2s linear infinite reverse;
    border-top-color: rgba(255, 0, 0, 0.3);
    border-bottom-color: rgba(0, 95, 212, 0.3);
}

/* ============ EMPTY STATE ============ */
.empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 80px;
    color: var(--text-tertiary);
    position: relative;
    overflow: hidden;
    border-radius: var(--border-radius);
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(20px);
    border: 2px dashed rgba(255, 255, 255, 0.1);
}

.empty-state i {
    font-size: 80px;
    margin-bottom: 32px;
    opacity: 0.5;
    animation: emptyStateFloat 4s ease-in-out infinite,
               emptyStateGlow 2s ease-in-out infinite alternate;
    filter: drop-shadow(0 0 20px currentColor);
}

/* ============ FORM ELEMENTS ============ */
.form-group {
    margin-bottom: 28px;
    animation: fadeInUp 0.6s ease;
    position: relative;
}

.form-group label {
    display: block;
    margin-bottom: 12px;
    font-weight: 600;
    color: var(--text-primary);
    font-family: 'Rajdhani', sans-serif;
    font-size: 16px;
    letter-spacing: 1px;
    text-transform: uppercase;
    position: relative;
    display: inline-block;
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 18px 24px;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--border-radius-sm);
    color: var(--text-primary);
    font-size: 16px;
    font-family: 'Poppins', sans-serif;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    backdrop-filter: blur(10px);
    letter-spacing: 0.5px;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary);
    background: rgba(255, 255, 255, 0.08);
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(255, 0, 0, 0.2),
                0 0 0 4px rgba(255, 0, 0, 0.1);
}

/* ============ FILE INFO ============ */
.file-info {
    background: linear-gradient(135deg, rgba(255,0,0,0.1), rgba(0,95,212,0.1));
    border-radius: var(--border-radius-sm);
    padding: 24px;
    margin-bottom: 24px;
    border-left: 6px solid var(--primary);
    animation: fadeIn 0.5s ease,
               infoGlow 3s ease-in-out infinite alternate;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* ============ UPLOAD AREA ============ */
.upload-area {
    border: 3px dashed rgba(255, 255, 255, 0.2);
    border-radius: var(--border-radius);
    padding: 64px 32px;
    text-align: center;
    margin-bottom: 32px;
    transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    cursor: none;
    position: relative;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.02);
    backdrop-filter: blur(10px);
}

.upload-area.dragover {
    border-color: var(--accent-1);
    background: rgba(255, 0, 255, 0.1);
    transform: scale(0.98);
    animation: dragPulse 0.6s ease-in-out infinite alternate;
}

.upload-icon {
    font-size: 72px;
    color: var(--primary);
    margin-bottom: 24px;
    animation: float 3s ease-in-out infinite,
               iconGlow 2s ease-in-out infinite alternate;
    filter: drop-shadow(0 0 10px var(--primary));
}

/* ============ NEW AVATAR OVERLAY STYLES ============ */
.avatar-overlay-controls {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
    z-index: 20;
}

.avatar-overlay-btn {
    background: rgba(0, 0, 0, 0.7);
    border: 1px solid var(--primary);
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
}

.avatar-overlay-btn:hover {
    background: var(--primary);
    transform: scale(1.1);
}

.avatar-mirror {
    position: absolute;
    bottom: 10px;
    right: 10px;
    width: 100px;
    height: 100px;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 10px;
    overflow: hidden;
    border: 2px solid var(--primary);
    z-index: 15;
}

#avatarMirrorCanvas {
    width: 100%;
    height: 100%;
}

/* ============ ANIMATION KEYFRAMES ============ */
@keyframes rotateGradient {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes floatAround {
    0%, 100% { transform: translate(0, 0) rotate(0deg); }
    25% { transform: translate(100px, 50px) rotate(90deg); }
    50% { transform: translate(50px, 100px) rotate(180deg); }
    75% { transform: translate(-50px, 50px) rotate(270deg); }
}

@keyframes logoGlow {
    0% { filter: drop-shadow(0 0 5px var(--primary)); }
    100% { filter: drop-shadow(0 0 20px var(--primary)) drop-shadow(0 0 30px var(--accent-1)); }
}

@keyframes logoSpin {
    0% { transform: rotate(0deg) scale(1); }
    50% { transform: rotate(180deg) scale(1.2); }
    100% { transform: rotate(360deg) scale(1); }
}

@keyframes trailFade {
    0% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.2); }
}

@keyframes rippleEffect {
    0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(3); opacity: 0; }
}

@keyframes pulseEffect {
    0%, 100% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.5); }
}

@keyframes spinEffect {
    0% { transform: translate(-50%, -50%) rotate(0deg) scale(1); }
    100% { transform: translate(-50%, -50%) rotate(360deg) scale(1); }
}

@keyframes bounceEffect {
    0% { transform: translate(-50%, -50%) scale(1); }
    100% { transform: translate(-50%, -50%) scale(1.3); }
}

@keyframes shakeEffect {
    0%, 100% { transform: translate(-50%, -50%) translateX(0); }
    25% { transform: translate(-50%, -50%) translateX(5px); }
    75% { transform: translate(-50%, -50%) translateX(-5px); }
}

@keyframes colorCycle {
    0% { background-color: #ff0000; }
    25% { background-color: #00ff00; }
    50% { background-color: #0000ff; }
    75% { background-color: #ffff00; }
    100% { background-color: #ff0000; }
}

@keyframes rainbowEffect {
    0% { background-position: 0% 50%; }
    100% { background-position: 100% 50%; }
}

@keyframes expandEffect {
    0% { width: 40px; height: 40px; opacity: 0.5; }
    100% { width: 80px; height: 80px; opacity: 0; }
}

@keyframes rotateEffect {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

@keyframes waveEffect {
    0%, 100% { border-width: 2px; }
    50% { border-width: 6px; }
}

@keyframes dashRotate {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

@keyframes neonPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(40px) scale(0.9); filter: blur(20px); }
    to { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
}

@keyframes containerGlow {
    0% { box-shadow: var(--shadow-lg), 0 0 40px rgba(255, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.1); }
    100% { box-shadow: var(--shadow-lg), 0 0 80px rgba(255, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2); }
}

@keyframes borderGlow {
    0%, 100% { opacity: 0.2; filter: blur(20px); }
    50% { opacity: 0.4; filter: blur(30px); }
}

@keyframes cardAppear {
    from { opacity: 0; transform: scale(0.8) rotateY(45deg); }
    to { opacity: 1; transform: scale(1) rotateY(0); }
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

@keyframes modalFadeIn {
    from { opacity: 0; backdrop-filter: blur(0); }
    to { opacity: 1; backdrop-filter: blur(50px); }
}

@keyframes modalBgPulse {
    0% { opacity: 0.3; transform: scale(1); }
    100% { opacity: 0.5; transform: scale(1.1); }
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-30px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes modalBodyAppear {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes playerGlow {
    0% { opacity: 0.2; filter: blur(20px); }
    100% { opacity: 0.4; filter: blur(40px); }
}

@keyframes likePulse {
    0% { box-shadow: 0 5px 20px rgba(255, 0, 0, 0.3); }
    100% { box-shadow: 0 5px 40px rgba(255, 0, 0, 0.6), inset 0 0 20px rgba(255, 255, 255, 0.2); }
}

@keyframes commentsSlideIn {
    from { opacity: 0; transform: translateX(30px); }
    to { opacity: 1; transform: translateX(0); }
}

@keyframes commentsListAppear {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes commentSlideIn {
    from { opacity: 0; transform: translateX(-30px) rotateY(45deg); }
    to { opacity: 1; transform: translateX(0) rotateY(0); }
}

@keyframes commentLikePulse {
    0% { box-shadow: 0 5px 20px rgba(52, 152, 219, 0.3); }
    100% { box-shadow: 0 5px 35px rgba(52, 152, 219, 0.5), inset 0 0 20px rgba(255, 255, 255, 0.1); }
}

@keyframes dropdownAppear {
    from { opacity: 0; transform: scale(0.8) translateY(-20px) rotateX(45deg); filter: blur(10px); }
    to { opacity: 1; transform: scale(1) translateY(0) rotateX(0); filter: blur(0); }
}

@keyframes notificationSlideIn {
    from { opacity: 0; transform: translateX(100px) rotateY(90deg); filter: blur(20px); }
    to { opacity: 1; transform: translateX(0) rotateY(0); filter: blur(0); }
}

@keyframes notificationGlow {
    0% { box-shadow: var(--shadow-lg), 0 0 30px rgba(255, 0, 0, 0.2); }
    100% { box-shadow: var(--shadow-lg), 0 0 70px rgba(255, 0, 0, 0.4); }
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes colorShift {
    0% { border-top-color: var(--primary); border-right-color: var(--secondary); border-bottom-color: var(--accent-1); border-left-color: var(--accent-2); }
    25% { border-top-color: var(--accent-2); border-right-color: var(--primary); border-bottom-color: var(--secondary); border-left-color: var(--accent-1); }
    50% { border-top-color: var(--accent-1); border-right-color: var(--accent-2); border-bottom-color: var(--primary); border-left-color: var(--secondary); }
    75% { border-top-color: var(--secondary); border-right-color: var(--accent-1); border-bottom-color: var(--accent-2); border-left-color: var(--primary); }
    100% { border-top-color: var(--primary); border-right-color: var(--secondary); border-bottom-color: var(--accent-1); border-left-color: var(--accent-2); }
}

@keyframes emptyStateFloat {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-30px) rotate(5deg); }
    75% { transform: translateY(-15px) rotate(-5deg); }
}

@keyframes emptyStateGlow {
    0% { filter: drop-shadow(0 0 10px currentColor); }
    100% { filter: drop-shadow(0 0 40px currentColor); }
}

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes infoGlow {
    0% { box-shadow: 0 5px 20px rgba(255, 0, 0, 0.2); }
    100% { box-shadow: 0 5px 40px rgba(255, 0, 0, 0.4); }
}

@keyframes dragPulse {
    from { box-shadow: 0 0 30px rgba(255, 0, 255, 0.3); }
    to { box-shadow: 0 0 60px rgba(255, 0, 255, 0.6); }
}

@keyframes float {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(5deg); }
}

@keyframes iconGlow {
    0% { filter: drop-shadow(0 0 10px var(--primary)); }
    100% { filter: drop-shadow(0 0 30px var(--primary)); }
}

/* ============ RESPONSIVE DESIGN ============ */
@media (max-width: 1400px) {
    .sidebar {
        width: 100px;
    }
    
    .sidebar-item span {
        display: none;
    }
    
    .main-content {
        margin-left: 100px;
    }
    
    .modal-body {
        flex-direction: column;
        height: auto;
    }
    
    .video-sidebar {
        min-width: 100%;
        max-height: 500px;
    }
}

@media (max-width: 1024px) {
    .header {
        padding: 0 20px;
        gap: 24px;
    }
    
    .videos-grid {
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 24px;
    }
    
    .upload-container {
        padding: 40px;
        margin: 0 20px;
    }
    
    .modal-content {
        padding: 24px;
    }
    
    .modal-body {
        flex-direction: column;
        gap: 24px;
        height: auto;
    }
    
    .comment-form {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .comment-input-container {
        width: 100%;
    }
    
    .comment-submit {
        align-self: flex-end;
    }
    
    .customization-panel {
        width: 320px;
    }
}

@media (max-width: 768px) {
    .header {
        padding: 0 16px;
        gap: 16px;
        height: 60px;
    }
    
    .logo {
        font-size: 22px;
    }
    
    .logo-icon {
        font-size: 26px;
    }
    
    .search-container {
        display: none !important;
    }
    
    .search-bar.mobile-visible {
        display: flex !important;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        margin: 0 16px;
        z-index: 10001;
        animation: mobileSearchSlide 0.4s ease;
    }
    
    .videos-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
    }
    
    .sidebar {
        width: 80px;
        transform: translateX(-100%);
        transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .sidebar.visible {
        transform: translateX(0);
    }
    
    .main-content {
        margin-left: 0;
        padding: 20px;
    }
    
    .upload-btn span {
        display: none;
    }
    
    .avatar-overlay {
        width: 100px;
        height: 150px;
        top: 10px;
        right: 10px;
    }
    
    .avatar-mirror {
        display: none;
    }
    
    /* Disable heavy effects on mobile for performance */
    .cursor-container,
    .particles-js-canvas-el,
    .floating-element,
    .gradient-bg,
    .video-card::after,
    .video-card::before {
        display: none;
    }
    
    * {
        cursor: auto !important;
    }
    
    .customization-panel {
        width: 100%;
        right: -100%;
    }
    
    .cursor-grid {
        grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    }
}

@media (max-width: 480px) {
    .sidebar {
        width: 280px;
        transform: translateX(-100%);
    }
    
    .videos-grid {
        grid-template-columns: 1fr;
    }
    
    .video-player {
        aspect-ratio: 9 / 16;
    }
    
    .upload-container {
        padding: 32px 20px;
        margin: 0 12px;
    }
    
    .notification {
        top: 20px;
        right: 20px;
        left: 20px;
        max-width: none;
    }
    
    .comment-item {
        flex-direction: column;
        gap: 16px;
    }
    
    .comment-actions {
        justify-content: center;
    }
}

/* ============ MOBILE MENU TOGGLE ============ */
.mobile-menu-toggle {
    display: none;
    background: none;
    border: none;
    color: var(--text-primary);
    font-size: 24px;
    cursor: pointer;
    padding: 8px;
    transition: all 0.3s ease;
}

.search-toggle {
    display: none;
    background: none;
    border: none;
    color: var(--text-primary);
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    transition: all 0.3s ease;
}

@media (max-width: 768px) {
    .mobile-menu-toggle {
        display: block;
    }
    
    .search-toggle {
        display: block;
    }
}

@keyframes mobileSearchSlide {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ============ LOADING SCREEN ============ */
.loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--darker-bg);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: opacity 0.5s ease;
}

.loading-logo {
    font-size: 4rem;
    margin-bottom: 30px;
    animation: pulse 2s infinite;
    background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent-1));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.loading-bar {
    width: 300px;
    height: 10px;
    background: rgba(108, 92, 231, 0.2);
    border-radius: 5px;
    overflow: hidden;
    margin-top: 20px;
}

.loading-progress {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    width: 0%;
    transition: width 0.3s ease;
}

.loading-text {
    margin-top: 20px;
    color: var(--text-tertiary);
    font-family: 'Orbitron', sans-serif;
}

/* ============ UTILITY CLASSES ============ */
.gradient-text {
    background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent-1));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.pulse {
    animation: pulse 2s infinite;
}

.float {
    animation: float 6s ease-in-out infinite;
}

.spin {
    animation: particle-spin 10s linear infinite;
}

.btn {
    padding: 12px 24px;
    border-radius: var(--border-radius-sm);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    position: relative;
    overflow: hidden;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    box-shadow: 0 5px 15px rgba(255, 0, 0, 0.4);
}

.btn-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(255, 0, 0, 0.6);
}

.btn-secondary {
    background: transparent;
    color: var(--secondary);
    border: 2px solid var(--secondary);
    box-shadow: 0 0 15px rgba(0, 206, 201, 0.3);
}

.btn-secondary:hover {
    background: rgba(0, 206, 201, 0.1);
    transform: translateY(-3px);
    box-shadow: 0 0 25px rgba(0, 206, 201, 0.5);
}

.hidden {
    display: none !important;
}

.visible {
    display: block !important;
}

.text-center {
    text-align: center;
}

.w-100 {
    width: 100%;
}

.mt-1 { margin-top: 10px; }
.mt-2 { margin-top: 20px; }
.mt-3 { margin-top: 30px; }
.mb-1 { margin-bottom: 10px; }
.mb-2 { margin-bottom: 20px; }
.mb-3 { margin-bottom: 30px; }
.p-1 { padding: 10px; }
.p-2 { padding: 20px; }
.p-3 { padding: 30px; }

/* Animation Performance Optimizations */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* Print Styles */
@media print {
    .header,
    .sidebar,
    .upload-btn,
    .user-menu,
    .video-actions-bar,
    .comment-form,
    .comments-section,
    .customization-panel {
        display: none !important;
    }
    
    .main-content {
        margin-left: 0;
        padding: 0;
    }
    
    .videos-grid {
        display: block;
    }
    
    .video-card {
        break-inside: avoid;
        margin-bottom: 20px;
        box-shadow: none;
        border: 1px solid #ccc;
    }
}
</style>
</head>
<body class="cursor-default">

<!-- Loading Screen -->
<div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">Vibro-X Ultimate</div>
    <div class="loading-bar">
        <div class="loading-progress" id="loadingProgress"></div>
    </div>
    <div class="loading-text" id="loadingText">Initializing Ultimate Platform...</div>
</div>

<!-- Background Effects -->
<div class="background-effects">
    <div class="gradient-bg"></div>
    <div class="floating-element"></div>
    <div class="floating-element"></div>
    <div class="floating-element"></div>
</div>

<!-- Matrix Background -->
<div class="matrix-bg">
    <canvas id="matrix-canvas"></canvas>
</div>

<!-- Particles Container -->
<div id="particles-js"></div>

<!-- Custom Cursor System -->
<div class="cursor-container">
    <div class="cursor-dot"></div>
    <div class="cursor-outline"></div>
</div>

<!-- Header -->
<header class="header">
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <a href="#" class="logo" id="logoBtn">
        <i class="fas fa-play-circle logo-icon"></i>
        <span>Vibro-X</span>
    </a>
    
    <div class="search-container">
        <div class="search-bar" id="searchBar">
            <input type="text" class="search-input" placeholder="Search videos..." id="searchInput">
            <button class="search-button" id="searchButton">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    
    <button class="search-toggle" id="searchToggle">
        <i class="fas fa-search"></i>
    </button>
    
    <div class="header-actions">
        <button class="upload-btn" id="uploadBtn">
            <i class="fas fa-upload"></i>
            <span>Upload</span>
        </button>
        
        <button class="customize-toggle-btn btn btn-secondary" id="customizeToggleBtn">
            <i class="fas fa-sliders-h"></i>
            <span>Customize</span>
        </button>
        
        <div class="user-menu">
            <img src="https://ui-avatars.com/api/?name=User&background=random" 
                 alt="User" 
                 class="user-avatar" 
                 id="userAvatar">
            
            <div class="user-dropdown" id="userDropdown">
                <div class="dropdown-header" id="dropdownHeader">
                    <h3>Guest User</h3>
                    <p>Sign in to upload videos</p>
                </div>
                <button class="dropdown-item" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Sign In</span>
                </button>
                <button class="dropdown-item" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
                <button class="dropdown-item" id="settingsBtn">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </button>
                <button class="dropdown-item" id="themeToggle">
                    <i class="fas fa-palette"></i>
                    <span>Toggle Theme</span>
                </button>
            </div>
        </div>
    </div>
</header>

<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
    <a href="#" class="sidebar-item active" id="homeBtn">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </a>
    <a href="#" class="sidebar-item" id="trendingBtn">
        <i class="fas fa-fire"></i>
        <span>Trending</span>
    </a>
    <a href="#" class="sidebar-item" id="historyBtn">
        <i class="fas fa-history"></i>
        <span>History</span>
    </a>
    <a href="#" class="sidebar-item" id="likedBtn">
        <i class="fas fa-thumbs-up"></i>
        <span>Liked videos</span>
    </a>
    <a href="#" class="sidebar-item" id="yourVideosBtn">
        <i class="fas fa-play-circle"></i>
        <span>Your videos</span>
    </a>
    <a href="#" class="sidebar-item" id="watchLaterBtn">
        <i class="fas fa-clock"></i>
        <span>Watch later</span>
    </a>
    <div class="sidebar-divider"></div>
    <a href="#" class="sidebar-item" id="avatarsBtn">
        <i class="fas fa-user-astronaut"></i>
        <span>Avatars</span>
    </a>
    <a href="#" class="sidebar-item" id="effectsBtn">
        <i class="fas fa-magic"></i>
        <span>Effects</span>
    </a>
    <a href="#" class="sidebar-item" id="physicsBtn">
        <i class="fas fa-atom"></i>
        <span>Physics</span>
    </a>
    <a href="#" class="sidebar-item" id="soundBtn">
        <i class="fas fa-volume-up"></i>
        <span>Sound</span>
    </a>
</nav>

<!-- Main Content -->
<main class="main-container">
    <div class="main-content page-transition">
        <!-- Upload Section -->
        <div class="upload-container" id="uploadSection" style="display: none;">
            <h2 class="gradient-text">Upload Video</h2>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h3>Select video to upload</h3>
                <p>or drag and drop video file</p>
                <p class="text-tertiary">MP4, WebM, MOV up to 500MB</p>
                <button class="btn-primary" id="selectFileBtn">
                    <i class="fas fa-file-video"></i>
                    Select Files
                </button>
            </div>
            
            <input type="file" id="videoFile" accept="video/*" style="display: none;">
            <input type="file" id="coverFile" accept="image/*" style="display: none;">
            
            <div id="fileInfo" class="file-info" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4 id="fileName"></h4>
                        <p id="fileSize" class="text-tertiary"></p>
                    </div>
                    <button class="btn-secondary" id="clearFileBtn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <form id="uploadForm">
                <div class="form-group">
                    <label for="videoTitle">Title *</label>
                    <input type="text" id="videoTitle" placeholder="Enter video title" required>
                </div>
                
                <div class="form-group">
                    <label for="videoDescription">Description</label>
                    <textarea id="videoDescription" placeholder="Tell viewers about your video"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="videoCategory">Category</label>
                        <select id="videoCategory">
                            <option value="">Select category</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="music">Music</option>
                            <option value="gaming">Gaming</option>
                            <option value="education">Education</option>
                            <option value="sports">Sports</option>
                            <option value="tech">Technology</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="videoPrivacy">Privacy</label>
                        <select id="videoPrivacy">
                            <option value="public">Public</option>
                            <option value="unlisted">Unlisted</option>
                            <option value="private">Private</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Tags (comma separated)</label>
                    <input type="text" id="videoTags" placeholder="e.g., gaming, tutorial, vlog">
                </div>
                
                <div class="form-group">
                    <label>Video Settings</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="allowComments" checked>
                            <span>Allow comments</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="allowRatings" checked>
                            <span>Allow ratings</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="showViewCount" checked>
                            <span>Show view count</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="aiGenerated">
                            <span>AI Generated</span>
                        </label>
                    </div>
                </div>
                
                <div class="upload-actions">
                    <button type="submit" class="btn-primary" id="submitUploadBtn">
                        <i class="fas fa-upload"></i>
                        Upload Video
                    </button>
                    <button type="button" class="btn-secondary" id="cancelUploadBtn">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Videos Grid -->
        <div id="videosSection">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                <h2 class="gradient-text">Recommended Videos</h2>
                <div>
                    <select id="sortVideos" class="comments-sort">
                        <option value="newest">Newest first</option>
                        <option value="popular">Most popular</option>
                        <option value="oldest">Oldest first</option>
                    </select>
                </div>
            </div>
            
            <div class="videos-grid" id="videosList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading videos...</p>
                </div>
            </div>
            
            <div class="load-more-comments" id="loadMoreContainer" style="display: none;">
                <button class="load-more-btn" id="loadMoreBtn">
                    <i class="fas fa-redo"></i>
                    Load More Videos
                </button>
            </div>
        </div>
    </div>
</main>

<!-- Video Player Modal -->
<div class="video-modal" id="videoModal">
    <div class="modal-content">
        <div class="modal-header">
            <button class="close-modal" id="closeModalBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="video-player-container">
                <div class="video-player" id="modalVideoContainer">
                    <video id="modalVideo" controls playsinline>
                        Your browser does not support the video tag.
                    </video>
                    <div class="avatar-overlay" id="avatarOverlay">
                        <canvas id="videoAvatarCanvas"></canvas>
                        <div class="avatar-overlay-controls">
                            <button class="avatar-overlay-btn" id="toggleAvatarBtn">
                                <i class="fas fa-user"></i>
                            </button>
                            <button class="avatar-overlay-btn" id="toggleMirrorBtn">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="avatar-mirror" id="avatarMirror">
                            <canvas id="avatarMirrorCanvas"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="video-details">
                    <h1 class="video-title-large gradient-text" id="modalVideoTitle"></h1>
                    
                    <div class="video-meta">
                        <div class="video-views" id="modalVideoMeta"></div>
                        <div class="video-actions-bar">
                            <button class="action-btn" id="likeBtn">
                                <i class="far fa-thumbs-up"></i>
                                <span id="likeCount">0</span>
                            </button>
                            <button class="action-btn" id="shareBtn">
                                <i class="fas fa-share"></i>
                                <span>Share</span>
                            </button>
                            <button class="action-btn" id="saveBtn">
                                <i class="far fa-bookmark"></i>
                                <span>Save</span>
                            </button>
                            <button class="action-btn" id="avatarViewBtn">
                                <i class="fas fa-user-astronaut"></i>
                                <span>View Avatar</span>
                            </button>
                            <button class="action-btn" id="reportBtn">
                                <i class="fas fa-flag"></i>
                                <span>Report</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="video-description">
                        <div id="videoDescriptionShort"></div>
                        <div id="videoDescriptionFull" style="display: none;"></div>
                        <button class="description-toggle" id="descriptionToggleBtn">
                            Show more
                        </button>
                    </div>
                </div>
                
                <!-- Comments Section -->
                <div class="comments-section" id="commentsSection">
                    <div class="comments-header">
                        <h3 class="comments-count" id="commentsCount">Comments</h3>
                        <select class="comments-sort" id="commentsSort">
                            <option value="newest">Newest first</option>
                            <option value="top">Top comments</option>
                            <option value="oldest">Oldest first</option>
                        </select>
                    </div>
                    
                    <div class="comment-form" id="commentForm">
                        <img src="https://ui-avatars.com/api/?name=User&background=random" 
                             alt="Your avatar" 
                             class="comment-avatar"
                             id="commentAvatar">
                        <div class="comment-input-container">
                            <input type="text" 
                                   class="comment-input" 
                                   id="commentInput" 
                                   placeholder="Add a comment...">
                            <button class="comment-submit" id="commentSubmitBtn">
                                Comment
                            </button>
                        </div>
                    </div>
                    
                    <div class="comments-list" id="commentsList">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <p>Loading comments...</p>
                        </div>
                    </div>
                    
                    <div class="load-more-comments" id="loadMoreComments" style="display: none;">
                        <button class="load-more-btn" id="loadMoreCommentsBtn">
                            Load more comments
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="video-sidebar">
                <div class="avatar-viewer-container">
                    <canvas id="modal-avatar-canvas"></canvas>
                    <div class="avatar-controls">
                        <button class="avatar-btn" id="rotateAvatarBtn">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="avatar-btn" id="zoomInBtn">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button class="avatar-btn" id="zoomOutBtn">
                            <i class="fas fa-search-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="recommended-videos" id="recommendedVideos">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading recommendations...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Customization Panel -->
<div class="customization-panel" id="customizationPanel">
    <div class="customization-header">
        <h2 class="gradient-text">Customize Experience</h2>
        <button class="btn btn-secondary" id="closeCustomizeBtn">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Cursor Selector -->
    <div class="customization-section">
        <h3 class="section-title">
            <i class="fas fa-mouse-pointer"></i>
            <span>Cursor Style</span>
        </h3>
        <div class="cursor-grid" id="cursorGrid">
            <!-- 40+ cursors will be loaded here -->
        </div>
    </div>
    
    <!-- Effects Selector -->
    <div class="customization-section">
        <h3 class="section-title">
            <i class="fas fa-magic"></i>
            <span>Visual Effects</span>
        </h3>
        <div class="slider-container">
            <div class="slider-header">
                <span class="slider-label">Effects Intensity</span>
                <span class="slider-value" id="effectsValue">50%</span>
            </div>
            <input type="range" min="0" max="100" value="50" class="slider" id="effectsSlider">
        </div>
        <div class="effects-presets" id="effectsPresets">
            <!-- Effect presets will be loaded here -->
        </div>
    </div>
    
    <!-- 3D Avatar Customization -->
    <div class="customization-section">
        <h3 class="section-title">
            <i class="fas fa-user-astronaut"></i>
            <span>3D Avatar</span>
        </h3>
        <div class="avatar-viewer-container">
            <canvas id="custom-avatar-canvas"></canvas>
            <div class="avatar-controls">
                <button class="avatar-btn" id="customRotateBtn">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="avatar-btn" id="customChangeBtn">
                    <i class="fas fa-random"></i>
                </button>
                <button class="avatar-btn" id="customEffectBtn">
                    <i class="fas fa-sparkles"></i>
                </button>
            </div>
        </div>
        <div class="avatar-options mt-2">
            <div class="toggle-group">
                <span>Avatar Glow</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="avatarGlowToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="toggle-group">
                <span>Particles</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="avatarParticlesToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="toggle-group">
                <span>Show in Videos</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="avatarVideoToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>
    
    <!-- Physics Settings -->
    <div class="customization-section">
        <h3 class="section-title">
            <i class="fas fa-atom"></i>
            <span>Physics Mechanics</span>
        </h3>
        <div class="physics-controls" id="physicsControls">
            <!-- Physics controls will be loaded here -->
        </div>
    </div>
    
    <!-- Sound Effects -->
    <div class="customization-section">
        <h3 class="section-title">
            <i class="fas fa-volume-up"></i>
            <span>Sound Effects</span>
        </h3>
        <div class="sound-board" id="soundBoard">
            <!-- Sound pads will be loaded here -->
        </div>
        <div class="slider-container mt-2">
            <div class="slider-header">
                <span class="slider-label">Volume</span>
                <span class="slider-value" id="volumeValue">70%</span>
            </div>
            <input type="range" min="0" max="100" value="70" class="slider" id="volumeSlider">
        </div>
    </div>
    
    <!-- Animation Settings -->
    <div class="customization-section">
        <h3 class="section-title">
            <i class="fas fa-film"></i>
            <span>Animations</span>
        </h3>
        <div class="slider-container">
            <div class="slider-header">
                <span class="slider-label">Animation Speed</span>
                <span class="slider-value" id="animationValue">100%</span>
            </div>
            <input type="range" min="10" max="200" value="100" class="slider" id="animationSlider">
        </div>
        <div class="toggle-group mt-2">
            <span>Enable Particle Effects</span>
            <label class="toggle-switch">
                <input type="checkbox" id="particleToggle" checked>
                <span class="toggle-slider"></span>
            </label>
        </div>
        <div class="toggle-group">
            <span>Enable Background Effects</span>
            <label class="toggle-switch">
                <input type="checkbox" id="bgEffectsToggle" checked>
                <span class="toggle-slider"></span>
            </label>
        </div>
    </div>
    
    <div class="customization-section">
        <button class="btn btn-primary w-100" id="saveSettingsBtn">
            <i class="fas fa-save"></i>
            Save Settings
        </button>
        <button class="btn btn-secondary w-100 mt-2" id="resetSettingsBtn">
            <i class="fas fa-redo"></i>
            Reset to Default
        </button>
    </div>
</div>

<!-- Notifications -->
<div class="notification" id="notification"></div>

<script>
// ============ GLOBAL STATE ============
const state = {
    currentCursor: 'cursor-default',
    activeEffects: 50,
    animationSpeed: 100,
    volume: 70,
    activePhysics: [],
    activeSounds: [],
    avatarScale: 1,
    avatarRotation: 0,
    particleEffects: true,
    backgroundEffects: true,
    avatarGlow: true,
    avatarParticles: false,
    avatarInVideo: true,
    selectedAvatar: null,
    avatarVisible: false,
    avatarMirror: false,
    advancedCursor: null,
    soundEffects: null,
    animationController: null,
    themeManager: null,
    threeJSAvatars: new Map(),
    currentUser: null,
    currentVideo: null,
    videosCache: [],
    commentsCache: {},
    displayedVideos: 0,
    pollingInterval: null,
    lastUpdateCheck: Date.now(),
    isMobile: /iPhone|iPad|Android/i.test(navigator.userAgent)
};

const VIDEOS_PER_PAGE = 12;
const COMMENTS_PER_PAGE = 20;
const POLLING_INTERVAL = 3000;

// ============ INITIALIZATION ============
document.addEventListener('DOMContentLoaded', async () => {
    await initAllSystems();
    setupEventListeners();
    setupUploadHandlers();
    setupTabHandlers();
    await loadCurrentUser();
    await loadVideos(true);
});

async function initAllSystems() {
    await simulateLoading();
    
    // Initialize all systems
    initParticles();
    initMatrixBackground();
    initCursorSystem();
    init3DAvatarSystem();
    initVideoModal();
    initCustomizationPanel();
    initSoundSystem();
    initPhysicsSystem();
    initEffectsSystem();
    
    // Initialize advanced systems
    state.advancedCursor = new AdvancedCursor();
    state.soundEffects = new SoundEffects();
    state.animationController = new AnimationController();
    state.themeManager = new ThemeManager();
    
    // Hide loading screen
    document.getElementById('loadingScreen').style.display = 'none';
    
    // Setup header scroll effect
    initHeaderScroll();
    
    // Load saved settings
    loadInitialData();
    
    console.log(' Ultimate Platform Initialized');
}

async function simulateLoading() {
    const steps = [
        {text: 'Initializing 40+ custom cursors...', progress: 10},
        {text: 'Loading 500+ animations...', progress: 25},
        {text: 'Setting up 3D avatar system...', progress: 40},
        {text: 'Configuring physics mechanics...', progress: 55},
        {text: 'Loading sound effects...', progress: 70},
        {text: 'Preparing visual effects...', progress: 85},
        {text: 'Initializing video platform...', progress: 95},
        {text: 'Ready!', progress: 100}
    ];
    
    for (const step of steps) {
        document.getElementById('loadingProgress').style.width = step.progress + '%';
        document.getElementById('loadingText').textContent = step.text;
        await new Promise(resolve => setTimeout(resolve, 400));
    }
}

// ============ PARTICLE BACKGROUND ============
function initParticles() {
    if (typeof particlesJS === 'undefined') return;
    
    particlesJS('particles-js', {
        particles: {
            number: { value: 80, density: { enable: true, value_area: 800 } },
            color: { value: "#ff0000" },
            shape: { type: "circle" },
            opacity: { value: 0.5, random: true, anim: { enable: true, speed: 1 } },
            size: { value: 3, random: true, anim: { enable: true, speed: 2 } },
            line_linked: {
                enable: true,
                distance: 150,
                color: "#ff0000",
                opacity: 0.2,
                width: 1
            },
            move: {
                enable: true,
                speed: 2,
                direction: "none",
                random: true,
                out_mode: "out",
                bounce: false
            }
        },
        interactivity: {
            detect_on: "canvas",
            events: {
                onhover: { enable: true, mode: "repulse" },
                onclick: { enable: true, mode: "push" },
                resize: true
            }
        }
    });
}

// ============ MATRIX BACKGROUND ============
function initMatrixBackground() {
    const canvas = document.getElementById('matrix-canvas');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    const chars = "01";
    const fontSize = 14;
    const columns = canvas.width / fontSize;
    const drops = Array(Math.floor(columns)).fill(1);
    
    function draw() {
        ctx.fillStyle = 'rgba(5, 5, 16, 0.04)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = '#00ff41';
        ctx.font = `${fontSize}px monospace`;
        
        for (let i = 0; i < drops.length; i++) {
            const text = chars[Math.floor(Math.random() * chars.length)];
            ctx.fillText(text, i * fontSize, drops[i] * fontSize);
            
            if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                drops[i] = 0;
            }
            drops[i]++;
        }
    }
    
    function animate() {
        draw();
        requestAnimationFrame(animate);
    }
    
    animate();
    
    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });
}

// ============ 40+ CURSOR SYSTEM ============
function initCursorSystem() {
    const cursorClasses = [
        'cursor-default', 'cursor-tech', 'cursor-game', 'cursor-neon', 'cursor-matrix',
        'cursor-physics', 'cursor-hologram', 'cursor-particle', 'cursor-wireframe',
        'cursor-digital', 'cursor-cyber', 'cursor-orb', 'cursor-quantum', 'cursor-neural',
        'cursor-grid', 'cursor-target', 'cursor-binary', 'cursor-energy', 'cursor-warp',
        'cursor-data', 'cursor-crystal', 'cursor-radar', 'cursor-galaxy', 'cursor-nebula',
        'cursor-time', 'cursor-fractal', 'cursor-circuit', 'cursor-hive', 'cursor-dna',
        'cursor-magnetic', 'cursor-sonic', 'cursor-laser', 'cursor-tesla', 'cursor-pyramid',
        'cursor-vortex', 'cursor-ai', 'cursor-cybercore', 'cursor-neonpulse', 'cursor-quantumfield',
        'cursor-digitalscan', 'cursor-atomic', 'cursor-neuro', 'cursor-hyperdrive', 'cursor-chronos',
        'cursor-singularity'
    ];
    
    const cursorGrid = document.getElementById('cursorGrid');
    cursorGrid.innerHTML = '';
    
    cursorClasses.forEach(cursorClass => {
        const cursorOption = document.createElement('div');
        cursorOption.className = 'cursor-option';
        cursorOption.dataset.cursor = cursorClass;
        cursorOption.innerHTML = `
            <i class="fas fa-mouse-pointer"></i>
            <span class="cursor-name">${cursorClass.replace('cursor-', '')}</span>
        `;
        
        cursorOption.addEventListener('click', () => {
            applyCursor(cursorClass);
            document.querySelectorAll('.cursor-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            cursorOption.classList.add('selected');
            createParticleBurst(15, 'cursor');
        });
        
        cursorGrid.appendChild(cursorOption);
    });
    
    // Apply default cursor
    const defaultOption = document.querySelector('.cursor-option[data-cursor="cursor-default"]');
    if (defaultOption) defaultOption.classList.add('selected');
}

function applyCursor(cursorClass) {
    document.body.className = document.body.className.replace(/cursor-\S+/g, '');
    document.body.classList.add(cursorClass);
    state.currentCursor = cursorClass;
    
    // Update cursor trail
    updateCursorTrail();
}

function updateCursorTrail() {
    const colors = {
        'cursor-neon': 'var(--ex-cyberpunk-pink)',
        'cursor-matrix': 'var(--ex-matrix-green)',
        'cursor-quantum': 'var(--ex-secondary)',
        'cursor-cyber': 'var(--ex-cyberpunk-blue)',
        'default': 'var(--primary)'
    };
    
    const trail = document.querySelector('.cursor-trail');
    if (trail) {
        trail.style.background = `radial-gradient(circle, ${colors[state.currentCursor] || colors.default}, transparent)`;
        trail.style.boxShadow = state.currentCursor.includes('neon') ? '0 0 15px var(--ex-cyberpunk-pink)' : '';
    }
}

// ============ ADVANCED CURSOR CLASS ============
class AdvancedCursor {
    constructor() {
        this.dot = document.querySelector('.cursor-dot');
        this.outline = document.querySelector('.cursor-outline');
        this.trails = [];
        this.particles = [];
        this.sparkles = [];
        this.x = 0;
        this.y = 0;
        this.lastX = 0;
        this.lastY = 0;
        this.velocity = { x: 0, y: 0 };
        this.acceleration = { x: 0, y: 0 };
        this.hoverState = 'default';
        this.effectMode = 'default';
        this.effects = [
            'ripple', 'pulse', 'spin', 'bounce', 'shake',
            'color-cycle', 'rainbow', 'expand', 'rotate', 'wave'
        ];
        this.currentEffect = 0;
        this.effectInterval = null;
        this.isMobile = /iPhone|iPad|Android/i.test(navigator.userAgent);
        
        this.init();
    }
    
    init() {
        if (this.isMobile) {
            if (this.dot) this.dot.style.display = 'none';
            if (this.outline) this.outline.style.display = 'none';
            return;
        }
        
        this.bindEvents();
        this.animate();
        this.startEffectCycle();
    }
    
    bindEvents() {
        document.addEventListener('mousemove', (e) => this.onMouseMove(e));
        document.addEventListener('mousedown', (e) => this.onMouseDown(e));
        document.addEventListener('mouseup', (e) => this.onMouseUp(e));
        document.addEventListener('mouseenter', (e) => this.onMouseEnter(e));
        document.addEventListener('mouseleave', (e) => this.onMouseLeave(e));
        
        document.addEventListener('mouseover', (e) => this.detectHover(e));
        document.addEventListener('mouseout', (e) => this.detectHover(e));
    }
    
    onMouseMove(e) {
        this.lastX = this.x;
        this.lastY = this.y;
        this.x = e.clientX;
        this.y = e.clientY;
        
        this.velocity.x = this.x - this.lastX;
        this.velocity.y = this.y - this.lastY;
        
        this.acceleration.x = this.velocity.x - (this.lastX - (this.x - this.velocity.x));
        this.acceleration.y = this.velocity.y - (this.lastY - (this.y - this.velocity.y));
        
        // Create trail
        if (Math.abs(this.velocity.x) > 2 || Math.abs(this.velocity.y) > 2) {
            this.createTrail();
        }
        
        // Update cursor position
        if (this.dot) {
            this.dot.style.left = `${this.x}px`;
            this.dot.style.top = `${this.y}px`;
        }
        if (this.outline) {
            this.outline.style.left = `${this.x}px`;
            this.outline.style.top = `${this.y}px`;
        }
        
        // Add subtle rotation based on velocity
        if (this.outline) {
            const rotation = Math.atan2(this.velocity.y, this.velocity.x) * (180 / Math.PI);
            this.outline.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`;
        }
    }
    
    createTrail() {
        if (!document.querySelector('.cursor-container')) return;
        
        for (let i = 0; i < 3; i++) {
            setTimeout(() => {
                const trail = document.createElement('div');
                trail.className = `cursor-trail trail-${i + 1}`;
                trail.style.left = `${this.x}px`;
                trail.style.top = `${this.y}px`;
                trail.style.background = this.dot ? this.dot.style.background || getComputedStyle(this.dot).backgroundColor : 'var(--primary)';
                
                document.querySelector('.cursor-container').appendChild(trail);
                
                setTimeout(() => {
                    if (trail.parentNode) {
                        trail.parentNode.removeChild(trail);
                    }
                }, 600);
            }, i * 50);
        }
    }
    
    detectHover(e) {
        const target = e.target;
        
        if (!this.dot || !this.outline) return;
        
        // Reset classes
        this.dot.classList.remove('hover-button', 'hover-video', 'hover-text', 'hover-input', 'hover-danger', 'hover-success');
        this.outline.classList.remove('hover-button', 'hover-video');
        
        if (target.matches('button, .btn, .action-btn, .upload-btn, .search-button')) {
            this.hoverState = 'button';
            this.dot.classList.add('hover-button');
            this.outline.classList.add('hover-button');
        } else if (target.matches('.video-card, .video-player, .video-thumbnail')) {
            this.hoverState = 'video';
            this.dot.classList.add('hover-video');
            this.outline.classList.add('hover-video');
        } else if (target.matches('h1, h2, h3, h4, h5, h6, p, span, .video-title')) {
            this.hoverState = 'text';
            this.dot.classList.add('hover-text');
        } else if (target.matches('input, textarea, select')) {
            this.hoverState = 'input';
            this.dot.classList.add('hover-input');
        } else if (target.matches('.danger, .error, [data-danger]')) {
            this.hoverState = 'danger';
            this.dot.classList.add('hover-danger');
        } else if (target.matches('.success, [data-success]')) {
            this.hoverState = 'success';
            this.dot.classList.add('hover-success');
        } else {
            this.hoverState = 'default';
        }
    }
    
    startEffectCycle() {
        this.effectInterval = setInterval(() => {
            this.cycleEffect();
        }, 5000);
    }
    
    cycleEffect() {
        if (!this.dot || !this.outline) return;
        
        this.effects.forEach(effect => {
            this.dot.classList.remove(`effect-${effect}`);
            this.outline.classList.remove(`effect-${effect}`);
        });
        
        const effect = this.effects[this.currentEffect];
        this.dot.classList.add(`effect-${effect}`);
        
        if (['expand', 'rotate', 'wave', 'dash'].includes(effect)) {
            this.outline.classList.add(`effect-${effect}`);
        }
        
        this.currentEffect = (this.currentEffect + 1) % this.effects.length;
    }
    
    animate() {
        if (!this.dot || !this.outline) return;
        
        const smoothX = this.x + this.velocity.x * 0.5;
        const smoothY = this.y + this.velocity.y * 0.5;
        
        this.dot.style.left = `${smoothX}px`;
        this.dot.style.top = `${smoothY}px`;
        
        const outlineX = this.outline.offsetLeft + (smoothX - this.outline.offsetLeft) * 0.1;
        const outlineY = this.outline.offsetTop + (smoothY - this.outline.offsetTop) * 0.1;
        
        this.outline.style.left = `${outlineX}px`;
        this.outline.style.top = `${outlineY}px`;
        
        requestAnimationFrame(() => this.animate());
    }
}

// ============ 3D AVATAR SYSTEM WITH FULL BODY METAHUMAN ============
async function init3DAvatarSystem() {
    await initAvatarCanvas('custom-avatar-canvas');
    await initAvatarCanvas('modal-avatar-canvas');
    await initAvatarCanvas('videoAvatarCanvas');
    await initAvatarCanvas('avatarMirrorCanvas');
}

async function initAvatarCanvas(canvasId) {
    const canvas = document.getElementById(canvasId);
    if (!canvas || typeof THREE === 'undefined') {
        createFallbackAvatar(canvas);
        return;
    }
    
    try {
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, canvas.offsetWidth / canvas.offsetHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        
        renderer.setSize(canvas.offsetWidth, canvas.offsetHeight);
        renderer.setClearColor(0x000000, 0);
        canvas.innerHTML = '';
        canvas.appendChild(renderer.domElement);
        
        // Add lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 5, 5);
        scene.add(directionalLight);
        
        // Create a more realistic full-body avatar
        const avatar = await createFullBodyAvatar();
        scene.add(avatar);
        
        // Position camera for full body view
        camera.position.set(0, 1.5, 3);
        camera.lookAt(0, 1, 0);
        
        // Add orbit controls for the customization panel
        let controls;
        if (canvasId === 'custom-avatar-canvas' || canvasId === 'modal-avatar-canvas') {
            if (typeof THREE.OrbitControls !== 'undefined') {
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.enableZoom = true;
                controls.enablePan = false;
            }
        }
        
        // Store references
        const avatarData = {
            scene: scene,
            camera: camera,
            renderer: renderer,
            avatar: avatar,
            controls: controls,
            animationMixer: null,
            clock: new THREE.Clock(),
            animations: []
        };
        
        state.threeJSAvatars.set(canvasId, avatarData);
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            const delta = avatarData.clock.getDelta();
            if (avatarData.animationMixer) {
                avatarData.animationMixer.update(delta);
            }
            
            if (controls) controls.update();
            
            // Rotate avatar slowly for modal view
            if (canvasId === 'modal-avatar-canvas' || canvasId === 'custom-avatar-canvas') {
                avatar.rotation.y += 0.005;
            }
            
            renderer.render(scene, camera);
        }
        animate();
        
        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = canvas.offsetWidth / canvas.offsetHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvas.offsetWidth, canvas.offsetHeight);
        });
        
        // For video overlay avatar, make it face forward
        if (canvasId === 'videoAvatarCanvas' || canvasId === 'avatarMirrorCanvas') {
            avatar.position.y = -0.5;
            camera.position.set(0, 1.5, 2);
            camera.lookAt(0, 1, 0);
        }
        
    } catch (error) {
        console.warn('Three.js initialization failed:', error);
        createFallbackAvatar(canvas);
    }
}

async function createFullBodyAvatar() {
    const group = new THREE.Group();
    
    // Head
    const headGeometry = new THREE.SphereGeometry(0.18, 32, 32);
    const headMaterial = new THREE.MeshPhongMaterial({ 
        color: 0xf0c8a0,
        shininess: 30,
        specular: 0x111111
    });
    const head = new THREE.Mesh(headGeometry, headMaterial);
    head.position.y = 1.65;
    group.add(head);
    
    // Hair
    const hairGeometry = new THREE.SphereGeometry(0.22, 32, 32);
    const hairMaterial = new THREE.MeshPhongMaterial({ 
        color: 0x2c1810,
        shininess: 10
    });
    const hair = new THREE.Mesh(hairGeometry, hairMaterial);
    hair.position.y = 1.78;
    hair.scale.y = 0.6;
    group.add(hair);
    
    // Body (torso)
    const bodyGeometry = new THREE.CylinderGeometry(0.25, 0.35, 0.8, 16);
    const bodyMaterial = new THREE.MeshPhongMaterial({ 
        color: 0x6c5ce7,
        shininess: 50
    });
    const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
    body.position.y = 0.9;
    group.add(body);
    
    // Arms
    const armGeometry = new THREE.CylinderGeometry(0.08, 0.06, 0.7, 8);
    const armMaterial = new THREE.MeshPhongMaterial({ 
        color: 0xf0c8a0,
        shininess: 30
    });
    
    // Left arm
    const leftArm = new THREE.Mesh(armGeometry, armMaterial);
    leftArm.position.set(-0.35, 0.9, 0);
    leftArm.rotation.z = Math.PI / 6;
    group.add(leftArm);
    
    // Right arm
    const rightArm = new THREE.Mesh(armGeometry, armMaterial);
    rightArm.position.set(0.35, 0.9, 0);
    rightArm.rotation.z = -Math.PI / 6;
    group.add(rightArm);
    
    // Hands
    const handGeometry = new THREE.SphereGeometry(0.09, 16, 16);
    const handMaterial = new THREE.MeshPhongMaterial({ 
        color: 0xf0c8a0,
        shininess: 30
    });
    
    const leftHand = new THREE.Mesh(handGeometry, handMaterial);
    leftHand.position.set(-0.6, 0.65, 0);
    group.add(leftHand);
    
    const rightHand = new THREE.Mesh(handGeometry, handMaterial);
    rightHand.position.set(0.6, 0.65, 0);
    group.add(rightHand);
    
    // Legs
    const legGeometry = new THREE.CylinderGeometry(0.12, 0.08, 0.9, 8);
    const legMaterial = new THREE.MeshPhongMaterial({ 
        color: 0x1a1a2e,
        shininess: 30
    });
    
    const leftLeg = new THREE.Mesh(legGeometry, legMaterial);
    leftLeg.position.set(-0.15, 0.05, 0);
    group.add(leftLeg);
    
    const rightLeg = new THREE.Mesh(legGeometry, legMaterial);
    rightLeg.position.set(0.15, 0.05, 0);
    group.add(rightLeg);
    
    // Feet
    const footGeometry = new THREE.BoxGeometry(0.15, 0.08, 0.25);
    const footMaterial = new THREE.MeshPhongMaterial({ 
        color: 0x333333,
        shininess: 10
    });
    
    const leftFoot = new THREE.Mesh(footGeometry, footMaterial);
    leftFoot.position.set(-0.15, -0.4, 0.1);
    group.add(leftFoot);
    
    const rightFoot = new THREE.Mesh(footGeometry, footMaterial);
    rightFoot.position.set(0.15, -0.4, 0.1);
    group.add(rightFoot);
    
    // Add glow effect
    const glowGeometry = new THREE.SphereGeometry(0.25, 16, 16);
    const glowMaterial = new THREE.MeshBasicMaterial({
        color: 0x6c5ce7,
        transparent: true,
        opacity: 0.3,
        side: THREE.BackSide
    });
    const glow = new THREE.Mesh(glowGeometry, glowMaterial);
    glow.position.y = 1.65;
    glow.scale.set(1.2, 1.2, 1.2);
    group.add(glow);
    
    // Add particles around avatar
    if (state.avatarParticles) {
        addAvatarParticles(group);
    }
    
    return group;
}

function addAvatarParticles(group) {
    const particleCount = 100;
    const particles = new THREE.BufferGeometry();
    const positions = new Float32Array(particleCount * 3);
    const colors = new Float32Array(particleCount * 3);
    
    for (let i = 0; i < particleCount; i++) {
        const i3 = i * 3;
        const radius = 1.5;
        const theta = Math.random() * Math.PI * 2;
        const phi = Math.random() * Math.PI;
        
        positions[i3] = radius * Math.sin(phi) * Math.cos(theta);
        positions[i3 + 1] = radius * Math.cos(phi) + 1.5;
        positions[i3 + 2] = radius * Math.sin(phi) * Math.sin(theta);
        
        colors[i3] = Math.random();
        colors[i3 + 1] = Math.random();
        colors[i3 + 2] = Math.random();
    }
    
    particles.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    particles.setAttribute('color', new THREE.BufferAttribute(colors, 3));
    
    const particleMaterial = new THREE.PointsMaterial({
        size: 0.05,
        vertexColors: true,
        transparent: true,
        opacity: 0.6
    });
    
    const particleSystem = new THREE.Points(particles, particleMaterial);
    group.add(particleSystem);
    
    // Store reference for animation
    particleSystem.userData = { speed: 0.01 };
    
    // Animate particles
    function animateParticles() {
        const positions = particleSystem.geometry.attributes.position.array;
        for (let i = 0; i < positions.length; i += 3) {
            positions[i] += (Math.random() - 0.5) * 0.02;
            positions[i + 1] += (Math.random() - 0.5) * 0.02;
            positions[i + 2] += (Math.random() - 0.5) * 0.02;
        }
        particleSystem.geometry.attributes.position.needsUpdate = true;
        requestAnimationFrame(animateParticles);
    }
    animateParticles();
}

function createFallbackAvatar(canvas) {
    if (!canvas) return;
    
    canvas.innerHTML = `
        <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle, rgba(108,92,231,0.2) 0%, rgba(0,0,0,0) 70%);">
            <div style="width: 200px; height: 300px; position: relative;">
                <div style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 80px; height: 80px; background: linear-gradient(135deg, var(--ex-primary), var(--ex-secondary)); border-radius: 50%;"></div>
                <div style="position: absolute; top: 80px; left: 50%; transform: translateX(-50%); width: 100px; height: 150px; background: linear-gradient(to bottom, var(--ex-tech-blue), var(--ex-tech-purple)); border-radius: 20px;"></div>
                <div style="position: absolute; top: 100px; left: 30%; width: 20px; height: 100px; background: var(--ex-primary); border-radius: 10px;"></div>
                <div style="position: absolute; top: 100px; left: 70%; width: 20px; height: 100px; background: var(--ex-primary); border-radius: 10px;"></div>
                <div style="position: absolute; top: 230px; left: 40%; width: 20px; height: 70px; background: var(--ex-secondary); border-radius: 10px;"></div>
                <div style="position: absolute; top: 230px; left: 60%; width: 20px; height: 70px; background: var(--ex-secondary); border-radius: 10px;"></div>
            </div>
        </div>
    `;
}

// ============ VIDEO MODAL WITH AVATAR OVERLAY ============
function initVideoModal() {
    const modal = document.getElementById('videoModal');
    const closeBtn = document.getElementById('closeModalBtn');
    const video = document.getElementById('modalVideo');
    
    if (!modal || !closeBtn || !video) return;
    
    closeBtn.addEventListener('click', () => {
        modal.classList.remove('show');
        video.pause();
        hideAvatarOverlay();
    });
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('show')) {
            modal.classList.remove('show');
            video.pause();
            hideAvatarOverlay();
        }
    });
    
    // Avatar overlay controls
    const toggleAvatarBtn = document.getElementById('toggleAvatarBtn');
    const toggleMirrorBtn = document.getElementById('toggleMirrorBtn');
    const avatarViewBtn = document.getElementById('avatarViewBtn');
    
    if (toggleAvatarBtn) {
        toggleAvatarBtn.addEventListener('click', () => {
            state.avatarVisible = !state.avatarVisible;
            const overlay = document.getElementById('avatarOverlay');
            if (overlay) {
                if (state.avatarVisible) {
                    overlay.classList.add('visible');
                    showNotification('Avatar overlay enabled', 'success');
                } else {
                    overlay.classList.remove('visible');
                    showNotification('Avatar overlay disabled', 'info');
                }
            }
        });
    }
    
    if (toggleMirrorBtn) {
        toggleMirrorBtn.addEventListener('click', () => {
            state.avatarMirror = !state.avatarMirror;
            const mirror = document.getElementById('avatarMirror');
            if (mirror) {
                mirror.style.display = state.avatarMirror ? 'block' : 'none';
                showNotification(`Avatar mirror ${state.avatarMirror ? 'enabled' : 'disabled'}`, 'info');
            }
        });
    }
    
    if (avatarViewBtn) {
        avatarViewBtn.addEventListener('click', () => {
            state.avatarVisible = !state.avatarVisible;
            const overlay = document.getElementById('avatarOverlay');
            if (overlay) {
                overlay.classList.toggle('visible');
                showNotification(`Avatar ${state.avatarVisible ? 'shown' : 'hidden'} in video`, 'info');
            }
        });
    }
    
    // Avatar controls
    const rotateAvatarBtn = document.getElementById('rotateAvatarBtn');
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    
    if (rotateAvatarBtn) {
        rotateAvatarBtn.addEventListener('click', () => {
            const avatar = state.threeJSAvatars.get('modal-avatar-canvas')?.avatar;
            if (avatar) {
                avatar.rotation.y += Math.PI / 4;
                createParticleBurst(20, 'avatar');
            }
        });
    }
    
    if (zoomInBtn) {
        zoomInBtn.addEventListener('click', () => {
            const avatarData = state.threeJSAvatars.get('modal-avatar-canvas');
            if (avatarData && avatarData.camera) {
                avatarData.camera.position.z = Math.max(1, avatarData.camera.position.z - 0.5);
            }
        });
    }
    
    if (zoomOutBtn) {
        zoomOutBtn.addEventListener('click', () => {
            const avatarData = state.threeJSAvatars.get('modal-avatar-canvas');
            if (avatarData && avatarData.camera) {
                avatarData.camera.position.z = Math.min(10, avatarData.camera.position.z + 0.5);
            }
        });
    }
}

function hideAvatarOverlay() {
    const overlay = document.getElementById('avatarOverlay');
    if (overlay) {
        overlay.classList.remove('visible');
        state.avatarVisible = false;
    }
}

// ============ CUSTOMIZATION PANEL ============
function initCustomizationPanel() {
    const panel = document.getElementById('customizationPanel');
    const toggleBtn = document.getElementById('customizeToggleBtn');
    const closeBtn = document.getElementById('closeCustomizeBtn');
    
    if (!panel || !toggleBtn || !closeBtn) return;
    
    toggleBtn.addEventListener('click', () => {
        panel.classList.toggle('active');
        createParticleBurst(15, 'effect');
    });
    
    closeBtn.addEventListener('click', () => {
        panel.classList.remove('active');
    });
    
    // Avatar controls
    const customRotateBtn = document.getElementById('customRotateBtn');
    const customChangeBtn = document.getElementById('customChangeBtn');
    const customEffectBtn = document.getElementById('customEffectBtn');
    
    if (customRotateBtn) {
        customRotateBtn.addEventListener('click', () => {
            const avatar = state.threeJSAvatars.get('custom-avatar-canvas')?.avatar;
            if (avatar) {
                avatar.rotation.y += Math.PI / 4;
            }
        });
    }
    
    if (customChangeBtn) {
        customChangeBtn.addEventListener('click', changeAvatarAppearance);
    }
    
    if (customEffectBtn) {
        customEffectBtn.addEventListener('click', () => createParticleBurst(50, 'avatar'));
    }
    
    // Sliders
    const effectsSlider = document.getElementById('effectsSlider');
    const animationSlider = document.getElementById('animationSlider');
    const volumeSlider = document.getElementById('volumeSlider');
    
    if (effectsSlider) {
        effectsSlider.addEventListener('input', (e) => {
            state.activeEffects = e.target.value;
            document.getElementById('effectsValue').textContent = `${state.activeEffects}%`;
            updateEffects();
        });
    }
    
    if (animationSlider) {
        animationSlider.addEventListener('input', (e) => {
            state.animationSpeed = e.target.value;
            document.getElementById('animationValue').textContent = `${state.animationSpeed}%`;
            updateAnimationSpeed();
        });
    }
    
    if (volumeSlider) {
        volumeSlider.addEventListener('input', (e) => {
            state.volume = e.target.value;
            document.getElementById('volumeValue').textContent = `${state.volume}%`;
        });
    }
    
    // Toggles
    const avatarGlowToggle = document.getElementById('avatarGlowToggle');
    const avatarParticlesToggle = document.getElementById('avatarParticlesToggle');
    const avatarVideoToggle = document.getElementById('avatarVideoToggle');
    const particleToggle = document.getElementById('particleToggle');
    const bgEffectsToggle = document.getElementById('bgEffectsToggle');
    
    if (avatarGlowToggle) {
        avatarGlowToggle.addEventListener('change', (e) => {
            state.avatarGlow = e.target.checked;
            updateAvatarGlow();
        });
    }
    
    if (avatarParticlesToggle) {
        avatarParticlesToggle.addEventListener('change', (e) => {
            state.avatarParticles = e.target.checked;
            if (state.avatarParticles) {
                // Add particles to all avatars
                state.threeJSAvatars.forEach((avatarData, canvasId) => {
                    if (avatarData.avatar) {
                        addAvatarParticles(avatarData.avatar);
                    }
                });
            }
        });
    }
    
    if (avatarVideoToggle) {
        avatarVideoToggle.addEventListener('change', (e) => {
            state.avatarInVideo = e.target.checked;
            if (!state.avatarInVideo) {
                hideAvatarOverlay();
            }
        });
    }
    
    if (particleToggle) {
        particleToggle.addEventListener('change', (e) => {
            state.particleEffects = e.target.checked;
            const particles = document.getElementById('particles-js');
            if (particles) {
                particles.style.display = state.particleEffects ? 'block' : 'none';
            }
        });
    }
    
    if (bgEffectsToggle) {
        bgEffectsToggle.addEventListener('change', (e) => {
            state.backgroundEffects = e.target.checked;
            document.querySelector('.background-effects').style.display = 
                state.backgroundEffects ? 'block' : 'none';
        });
    }
    
    // Save/Reset buttons
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const resetSettingsBtn = document.getElementById('resetSettingsBtn');
    
    if (saveSettingsBtn) {
        saveSettingsBtn.addEventListener('click', saveSettings);
    }
    
    if (resetSettingsBtn) {
        resetSettingsBtn.addEventListener('click', resetSettings);
    }
}

function changeAvatarAppearance() {
    const avatar = state.threeJSAvatars.get('custom-avatar-canvas')?.avatar;
    if (!avatar) return;
    
    const colors = [
        0x6c5ce7, 0x0984e3, 0x00cec9, 0xfd79a8,
        0x00b894, 0xa29bfe, 0xff7675, 0xfdcb6e
    ];
    
    const randomColor = colors[Math.floor(Math.random() * colors.length)];
    
    // Change body color
    if (avatar.children[2]) { // Body is third child
        avatar.children[2].material.color.setHex(randomColor);
    }
    
    createParticleBurst(20, 'avatar');
}

function updateAvatarGlow() {
    state.threeJSAvatars.forEach((avatarData, canvasId) => {
        if (avatarData.avatar && avatarData.avatar.children.length > 0) {
            // Find and update glow material
            for (let i = 0; i < avatarData.avatar.children.length; i++) {
                const child = avatarData.avatar.children[i];
                if (child.material && child.material.transparent) {
                    child.material.opacity = state.avatarGlow ? 0.3 : 0;
                }
            }
        }
    });
}

// ============ SOUND SYSTEM ============
function initSoundSystem() {
    const soundBoard = document.getElementById('soundBoard');
    if (!soundBoard) return;
    
    const sounds = [
        {name: 'Neural', icon: 'fas fa-brain', color: 'var(--ex-tech-blue)'},
        {name: 'Quantum', icon: 'fas fa-atom', color: 'var(--ex-secondary)'},
        {name: 'Cyber', icon: 'fas fa-bolt', color: 'var(--ex-cyberpunk-pink)'},
        {name: 'Matrix', icon: 'fas fa-code', color: 'var(--ex-matrix-green)'},
        {name: 'Hologram', icon: 'fas fa-hologram', color: 'var(--ex-tech-purple)'},
        {name: 'Click', icon: 'fas fa-mouse-pointer', color: 'var(--primary)'},
        {name: 'Confirm', icon: 'fas fa-check', color: 'var(--success)'},
        {name: 'Error', icon: 'fas fa-times', color: 'var(--danger)'}
    ];
    
    sounds.forEach(sound => {
        const pad = document.createElement('div');
        pad.className = 'sound-pad';
        pad.innerHTML = `
            <i class="${sound.icon}"></i>
            <span>${sound.name}</span>
        `;
        pad.style.borderColor = sound.color;
        
        pad.addEventListener('click', () => {
            playSound(sound.name.toLowerCase());
            pad.classList.add('active');
            setTimeout(() => pad.classList.remove('active'), 300);
        });
        
        soundBoard.appendChild(pad);
    });
}

function playSound(type) {
    if (!state.particleEffects || typeof Howler === 'undefined') return;
    
    const frequencies = {
        neural: 220,
        quantum: 440,
        cyber: 880,
        matrix: 1760,
        hologram: 293.66,
        click: 800,
        confirm: 1200,
        error: 200
    };
    
    const freq = frequencies[type] || 440;
    
    // Create oscillator with Web Audio API if available
    if (window.AudioContext || window.webkitAudioContext) {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = freq;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.3);
    }
    
    // Visual feedback
    createParticleBurst(15, type);
}

// ============ PHYSICS SYSTEM ============
function initPhysicsSystem() {
    const physicsControls = document.getElementById('physicsControls');
    if (!physicsControls) return;
    
    const mechanics = [
        {name: 'Gravity', icon: 'fas fa-globe-americas'},
        {name: 'Magnetism', icon: 'fas fa-magnet'},
        {name: 'Fluid', icon: 'fas fa-water'},
        {name: 'Particles', icon: 'fas fa-atom'},
        {name: 'Spring', icon: 'fas fa-expand-alt'},
        {name: 'Collision', icon: 'fas fa-car-crash'},
        {name: 'Ragdoll', icon: 'fas fa-running'},
        {name: 'Cloth', icon: 'fas fa-tshirt'},
        {name: 'Destruction', icon: 'fas fa-bomb'},
        {name: 'Quantum', icon: 'fas fa-door-open'}
    ];
    
    mechanics.forEach(mechanic => {
        const control = document.createElement('div');
        control.className = 'physics-control';
        control.innerHTML = `
            <i class="${mechanic.icon}"></i>
            <span>${mechanic.name}</span>
        `;
        
        control.addEventListener('click', () => {
            togglePhysicsMechanic(mechanic.name.toLowerCase());
            control.classList.toggle('active');
            createParticleBurst(20, 'physics');
        });
        
        physicsControls.appendChild(control);
    });
}

function togglePhysicsMechanic(mechanic) {
    const index = state.activePhysics.indexOf(mechanic);
    if (index > -1) {
        state.activePhysics.splice(index, 1);
    } else {
        state.activePhysics.push(mechanic);
    }
}

// ============ EFFECTS SYSTEM ============
function initEffectsSystem() {
    const effectsPresets = document.getElementById('effectsPresets');
    if (!effectsPresets) return;
    
    const presets = [
        {name: 'Neural', desc: 'Brainwave patterns', color: 'var(--ex-tech-blue)'},
        {name: 'Quantum', desc: 'Particle effects', color: 'var(--ex-secondary)'},
        {name: 'Cyberpunk', desc: 'Neon glitch', color: 'var(--ex-cyberpunk-pink)'},
        {name: 'Matrix', desc: 'Digital rain', color: 'var(--ex-matrix-green)'},
        {name: 'Hologram', desc: '3D projection', color: 'var(--ex-tech-purple)'},
        {name: 'Glitch', desc: 'Data corruption', color: 'var(--ex-tech-red)'},
        {name: 'Energy', desc: 'Power surges', color: 'var(--ex-tech-yellow)'},
        {name: 'Warp', desc: 'Space distortion', color: 'var(--ex-tech-purple)'}
    ];
    
    presets.forEach(preset => {
        const btn = document.createElement('div');
        btn.className = 'preset-btn';
        btn.innerHTML = `
            <div class="preset-name">${preset.name}</div>
            <div class="preset-desc">${preset.desc}</div>
        `;
        btn.style.borderColor = preset.color;
        
        btn.addEventListener('click', () => {
            applyEffectPreset(preset.name.toLowerCase());
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            createParticleBurst(30, 'effect');
        });
        
        effectsPresets.appendChild(btn);
    });
}

function applyEffectPreset(preset) {
    const effectTypes = {
        neural: 'neural-pulse',
        quantum: 'quantum-field',
        cyberpunk: 'cyber-grid',
        matrix: 'matrix-rain',
        hologram: 'hologram-scan',
        glitch: 'glitch',
        energy: 'energy-wave',
        warp: 'warp-tunnel'
    };
    
    const effect = effectTypes[preset];
    if (effect) {
        document.body.classList.add(effect);
        setTimeout(() => document.body.classList.remove(effect), 2000);
    }
}

function updateEffects() {
    const intensity = state.activeEffects / 100;
    document.body.style.filter = `
        brightness(${0.8 + intensity * 0.4})
        contrast(${0.9 + intensity * 0.2})
        saturate(${0.9 + intensity * 0.3})
    `;
}

function updateAnimationSpeed() {
    const speed = state.animationSpeed / 100;
    document.querySelectorAll('*').forEach(el => {
        const computedStyle = getComputedStyle(el);
        const animationName = computedStyle.animationName;
        if (animationName !== 'none') {
            const duration = parseFloat(computedStyle.animationDuration) || 1;
            el.style.animationDuration = `${duration / speed}s`;
        }
    });
}

// ============ SOUND EFFECTS SYSTEM ============
class SoundEffects {
    constructor() {
        this.audioContext = null;
        this.sounds = new Map();
        this.enabled = true;
        this.init();
    }
    
    init() {
        try {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            this.preloadSounds();
        } catch (e) {
            console.log('Web Audio API not supported');
            this.enabled = false;
        }
    }
    
    preloadSounds() {
        this.createSound('click', 800, 200, 0.1);
        this.createSound('hover', 400, 600, 0.05);
        this.createSound('success', 523.25, 1046.5, 0.3);
        this.createSound('error', 220, 110, 0.2);
        this.createSound('notification', 659.25, 830.61, 0.15);
        this.createSound('upload', 261.63, 523.25, 0.4);
    }
    
    createSound(name, freq1, freq2, duration) {
        if (!this.enabled) return;
        this.sounds.set(name, { freq1, freq2, duration });
    }
    
    play(name) {
        if (!this.enabled || !this.sounds.has(name)) return;
        
        const sound = this.sounds.get(name);
        if (!this.audioContext) {
            try {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                return;
            }
        }
        
        const oscillator = this.audioContext.createOscillator();
        const gainNode = this.audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(this.audioContext.destination);
        
        oscillator.frequency.setValueAtTime(sound.freq1, this.audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(sound.freq2, this.audioContext.currentTime + sound.duration);
        
        gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + sound.duration);
        
        oscillator.start();
        oscillator.stop(this.audioContext.currentTime + sound.duration);
    }
}

// ============ ANIMATION CONTROLLER ============
class AnimationController {
    constructor() {
        this.animations = new Map();
        this.observer = null;
        this.init();
    }
    
    init() {
        this.observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    this.animateElement(entry.target);
                }
            });
        }, {
            threshold: 0.1,
            rootMargin: '50px'
        });
        
        document.querySelectorAll('.video-card, .form-group, .comment-item').forEach(el => {
            this.observer.observe(el);
        });
    }
    
    animateElement(element) {
        if (element.classList.contains('animated')) return;
        element.classList.add('animated');
        
        if (element.classList.contains('video-card')) {
            this.animateVideoCard(element);
        } else if (element.classList.contains('comment-item')) {
            this.animateComment(element);
        } else if (element.classList.contains('form-group')) {
            this.animateFormGroup(element);
        }
    }
    
    animateVideoCard(card) {
        card.style.animation = 'cardAppear 0.6s ease backwards';
    }
    
    animateComment(comment) {
        comment.style.animation = 'commentSlideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) backwards';
    }
    
    animateFormGroup(formGroup) {
        formGroup.style.animation = 'fadeInUp 0.6s ease';
    }
    
    shakeElement(element) {
        element.style.animation = 'shakeEffect 0.5s ease-in-out';
        setTimeout(() => {
            element.style.animation = '';
        }, 500);
    }
    
    pulseElement(element) {
        element.style.animation = 'pulseEffect 0.5s ease-in-out';
        setTimeout(() => {
            element.style.animation = '';
        }, 500);
    }
}

// ============ THEME MANAGER ============
class ThemeManager {
    constructor() {
        this.themes = {
            dark: {
                '--primary': '#ff0000',
                '--primary-dark': '#cc0000',
                '--primary-light': '#ff3333',
                '--secondary': '#065fd4',
                '--secondary-light': '#4d8eff',
                '--accent-1': '#ff00ff',
                '--accent-2': '#00ffff',
                '--accent-3': '#ffff00',
                '--accent-4': '#00ff00',
                '--dark-bg': '#0a0a0a',
                '--darker-bg': '#050505',
                '--dark-surface': '#151515',
                '--dark-surface-light': '#222222',
                '--dark-surface-hover': '#333333',
                '--text-primary': '#ffffff',
                '--text-secondary': '#cccccc',
                '--text-tertiary': '#888888',
                '--border-color': '#404040'
            },
            light: {
                '--primary': '#ff0000',
                '--primary-dark': '#cc0000',
                '--primary-light': '#ff3333',
                '--secondary': '#065fd4',
                '--secondary-light': '#4d8eff',
                '--accent-1': '#ff00ff',
                '--accent-2': '#00ffff',
                '--accent-3': '#ffff00',
                '--accent-4': '#00ff00',
                '--dark-bg': '#f5f5f5',
                '--darker-bg': '#e0e0e0',
                '--dark-surface': '#ffffff',
                '--dark-surface-light': '#f0f0f0',
                '--dark-surface-hover': '#e5e5e5',
                '--text-primary': '#000000',
                '--text-secondary': '#333333',
                '--text-tertiary': '#666666',
                '--border-color': '#cccccc'
            },
            neon: {
                '--primary': '#ff0000',
                '--primary-dark': '#cc0000',
                '--primary-light': '#ff3333',
                '--secondary': '#00ffff',
                '--secondary-light': '#80ffff',
                '--accent-1': '#ff00ff',
                '--accent-2': '#ffff00',
                '--accent-3': '#00ff00',
                '--accent-4': '#ff8000',
                '--dark-bg': '#000000',
                '--darker-bg': '#000000',
                '--dark-surface': '#111111',
                '--dark-surface-light': '#222222',
                '--dark-surface-hover': '#333333',
                '--text-primary': '#ffffff',
                '--text-secondary': '#cccccc',
                '--text-tertiary': '#888888',
                '--border-color': '#ff00ff'
            },
            cyberpunk: {
                '--primary': '#00ffff',
                '--primary-dark': '#00cccc',
                '--primary-light': '#80ffff',
                '--secondary': '#ff00ff',
                '--secondary-light': '#ff80ff',
                '--accent-1': '#ffff00',
                '--accent-2': '#ff8000',
                '--accent-3': '#00ff00',
                '--accent-4': '#ff0000',
                '--dark-bg': '#0a0a1a',
                '--darker-bg': '#050510',
                '--dark-surface': '#151525',
                '--dark-surface-light': '#222235',
                '--dark-surface-hover': '#333345',
                '--text-primary': '#ffffff',
                '--text-secondary': '#ccccff',
                '--text-tertiary': '#8888aa',
                '--border-color': '#ff00ff'
            }
        };
        
        this.currentTheme = 'dark';
        this.init();
    }
    
    init() {
        const savedTheme = localStorage.getItem('vibro-theme');
        if (savedTheme && this.themes[savedTheme]) {
            this.setTheme(savedTheme);
        }
        
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', () => this.cycleTheme());
        }
    }
    
    setTheme(themeName) {
        if (!this.themes[themeName]) return;
        
        this.currentTheme = themeName;
        const theme = this.themes[themeName];
        
        Object.keys(theme).forEach(variable => {
            document.documentElement.style.setProperty(variable, theme[variable]);
        });
        
        localStorage.setItem('vibro-theme', themeName);
        this.playThemeTransition();
        showNotification(`Theme changed to ${themeName}`, 'info');
    }
    
    cycleTheme() {
        const themes = Object.keys(this.themes);
        const currentIndex = themes.indexOf(this.currentTheme);
        const nextIndex = (currentIndex + 1) % themes.length;
        this.setTheme(themes[nextIndex]);
    }
    
    playThemeTransition() {
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.right = '0';
        overlay.style.bottom = '0';
        overlay.style.background = 'var(--primary)';
        overlay.style.zIndex = '99999';
        overlay.style.opacity = '0';
        overlay.style.pointerEvents = 'none';
        
        document.body.appendChild(overlay);
        
        let opacity = 0;
        const fadeIn = setInterval(() => {
            opacity += 0.05;
            overlay.style.opacity = opacity;
            if (opacity >= 0.5) {
                clearInterval(fadeIn);
                setTimeout(() => {
                    const fadeOut = setInterval(() => {
                        opacity -= 0.05;
                        overlay.style.opacity = opacity;
                        if (opacity <= 0) {
                            clearInterval(fadeOut);
                            document.body.removeChild(overlay);
                        }
                    }, 16);
                }, 100);
            }
        }, 16);
    }
}

// ============ NOTIFICATION SYSTEM ============
function showNotification(message, type = 'info', duration = 3000) {
    const notification = document.getElementById('notification');
    if (!notification) return;
    
    const iconMap = {
        success: 'check-circle',
        error: 'exclamation-circle',
        warning: 'exclamation-triangle',
        info: 'info-circle'
    };
    
    notification.innerHTML = `
        <i class="fas fa-${iconMap[type] || 'info-circle'}"></i>
        <span>${message}</span>
    `;
    
    notification.className = `notification show ${type}`;
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, duration);
}

// ============ UTILITY FUNCTIONS ============
function createParticleBurst(count, type) {
    if (!state.particleEffects) return;
    
    const colors = {
        avatar: ['var(--ex-accent)', 'var(--ex-primary)', 'var(--ex-secondary)'],
        physics: ['var(--ex-tech-orange)', 'var(--ex-tech-yellow)', 'var(--ex-tech-red)'],
        effect: ['var(--ex-cyberpunk-pink)', 'var(--ex-cyberpunk-blue)', 'var(--ex-cyberpunk-yellow)'],
        cursor: ['var(--primary)', 'var(--secondary)', 'var(--accent-1)'],
        default: ['var(--primary)', 'var(--secondary)', 'var(--accent-1)']
    };
    
    const colorSet = colors[type] || colors.default;
    
    for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        particle.style.position = 'fixed';
        particle.style.left = '50%';
        particle.style.top = '50%';
        particle.style.width = Math.random() * 10 + 5 + 'px';
        particle.style.height = particle.style.width;
        particle.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        particle.style.background = colorSet[Math.floor(Math.random() * colorSet.length)];
        particle.style.pointerEvents = 'none';
        particle.style.zIndex = '9996';
        particle.style.transform = 'translate(-50%, -50%)';
        
        document.body.appendChild(particle);
        
        const angle = Math.random() * Math.PI * 2;
        const distance = 50 + Math.random() * 100;
        const targetX = Math.cos(angle) * distance;
        const targetY = Math.sin(angle) * distance;
        
        particle.animate([
            { transform: 'translate(-50%, -50%) scale(1)', opacity: 1 },
            { transform: `translate(calc(-50% + ${targetX}px), calc(-50% + ${targetY}px)) scale(0)`, opacity: 0 }
        ], {
            duration: 800 + Math.random() * 400,
            easing: 'cubic-bezier(0.1, 0.8, 0.2, 1)'
        }).onfinish = () => particle.remove();
    }
}

function saveSettings() {
    localStorage.setItem('vibro-x-settings', JSON.stringify(state));
    createParticleBurst(30, 'effect');
    showNotification('Settings saved!', 'success');
}

function resetSettings() {
    if (confirm('Reset all settings to default?')) {
        localStorage.removeItem('vibro-x-settings');
        localStorage.removeItem('vibro-theme');
        location.reload();
    }
}

function loadInitialData() {
    const savedSettings = localStorage.getItem('vibro-x-settings');
    if (savedSettings) {
        try {
            const savedState = JSON.parse(savedSettings);
            // Merge saved settings with current state
            Object.keys(savedState).forEach(key => {
                if (state[key] !== undefined) {
                    state[key] = savedState[key];
                }
            });
            
            // Update UI elements
            const effectsSlider = document.getElementById('effectsSlider');
            const animationSlider = document.getElementById('animationSlider');
            const volumeSlider = document.getElementById('volumeSlider');
            const avatarGlowToggle = document.getElementById('avatarGlowToggle');
            const avatarParticlesToggle = document.getElementById('avatarParticlesToggle');
            const avatarVideoToggle = document.getElementById('avatarVideoToggle');
            const particleToggle = document.getElementById('particleToggle');
            const bgEffectsToggle = document.getElementById('bgEffectsToggle');
            
            if (effectsSlider) {
                effectsSlider.value = state.activeEffects;
                document.getElementById('effectsValue').textContent = `${state.activeEffects}%`;
            }
            
            if (animationSlider) {
                animationSlider.value = state.animationSpeed;
                document.getElementById('animationValue').textContent = `${state.animationSpeed}%`;
            }
            
            if (volumeSlider) {
                volumeSlider.value = state.volume;
                document.getElementById('volumeValue').textContent = `${state.volume}%`;
            }
            
            if (avatarGlowToggle) avatarGlowToggle.checked = state.avatarGlow;
            if (avatarParticlesToggle) avatarParticlesToggle.checked = state.avatarParticles;
            if (avatarVideoToggle) avatarVideoToggle.checked = state.avatarInVideo;
            if (particleToggle) particleToggle.checked = state.particleEffects;
            if (bgEffectsToggle) bgEffectsToggle.checked = state.backgroundEffects;
            
            // Apply cursor
            if (state.currentCursor) {
                applyCursor(state.currentCursor);
                // Select the cursor in the grid
                document.querySelectorAll('.cursor-option').forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.dataset.cursor === state.currentCursor) {
                        opt.classList.add('selected');
                    }
                });
            }
            
            updateEffects();
            updateAnimationSpeed();
            updateAvatarGlow();
            
            // Update background effects visibility
            if (document.querySelector('.background-effects')) {
                document.querySelector('.background-effects').style.display = 
                    state.backgroundEffects ? 'block' : 'none';
            }
            
            // Update particles visibility
            const particles = document.getElementById('particles-js');
            if (particles) {
                particles.style.display = state.particleEffects ? 'block' : 'none';
            }
            
        } catch (e) {
            console.error('Error loading saved settings:', e);
        }
    }
}

// ============ ORIGINAL API FUNCTIONS (from first codebase) ============
// These functions remain exactly as they were

function setupEventListeners() {
    // User avatar dropdown
    const userAvatar = document.getElementById('userAvatar');
    const userDropdown = document.getElementById('userDropdown');
    
    if (userAvatar && userDropdown) {
        userAvatar.addEventListener('click', () => {
            userDropdown.classList.toggle('show');
        });
    }
    
    // Cancel upload button
    const cancelUploadBtn = document.getElementById('cancelUploadBtn');
    if (cancelUploadBtn) {
        cancelUploadBtn.addEventListener('click', () => {
            closeUploadModal();
        });
    }
    
    // Video modal buttons
    const closeModalBtn = document.getElementById('closeModalBtn');
    const likeBtn = document.getElementById('likeBtn');
    const shareBtn = document.getElementById('shareBtn');
    const commentSubmitBtn = document.getElementById('commentSubmitBtn');
    
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeVideoModal);
    }
    
    if (likeBtn) {
        likeBtn.addEventListener('click', toggleLike);
    }
    
    if (shareBtn) {
        shareBtn.addEventListener('click', shareVideo);
    }
    
    if (commentSubmitBtn) {
        commentSubmitBtn.addEventListener('click', postComment);
    }
    
    // Comment input
    const commentInput = document.getElementById('commentInput');
    if (commentInput) {
        commentInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                postComment();
            }
        });
    }
    
    // Load more buttons
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const loadMoreCommentsBtn = document.getElementById('loadMoreCommentsBtn');
    
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', () => loadVideos(false));
    }
    
    if (loadMoreCommentsBtn) {
        loadMoreCommentsBtn.addEventListener('click', () => loadComments(false));
    }
    
    // User buttons
    const logoutBtn = document.getElementById('logoutBtn');
    const loginBtn = document.getElementById('loginBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    
    if (logoutBtn) {
        logoutBtn.addEventListener('click', logout);
    }
    
    if (loginBtn) {
        loginBtn.addEventListener('click', () => window.location.href = '/login');
    }
    
    if (settingsBtn) {
        settingsBtn.addEventListener('click', openSettings);
    }
    
    // Search
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleSearch();
            }
        });
    }
    
    // Sort videos
    const sortVideos = document.getElementById('sortVideos');
    if (sortVideos) {
        sortVideos.addEventListener('change', async () => {
            const activeTab = document.querySelector('.sidebar-item.active');
            let viewType = 'home';
            
            if (activeTab) {
                const tabMap = {
                    'homeBtn': 'home',
                    'trendingBtn': 'trending',
                    'historyBtn': 'history',
                    'likedBtn': 'liked',
                    'yourVideosBtn': 'your-videos',
                    'watchLaterBtn': 'watch-later'
                };
                
                viewType = tabMap[activeTab.id] || 'home';
            }
            
            await loadVideosForView(viewType, true);
        });
    }
    
    // Sort comments
    const commentsSort = document.getElementById('commentsSort');
    if (commentsSort) {
        commentsSort.addEventListener('change', () => loadComments(true));
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (userDropdown && !e.target.closest('.user-menu') && userDropdown.classList.contains('show')) {
            userDropdown.classList.remove('show');
        }
        
        if (e.target.classList.contains('video-modal')) {
            closeVideoModal();
        }
    });
}

function initHeaderScroll() {
    let lastScroll = 0;
    const header = document.querySelector('.header');
    
    if (!header) return;
    
    window.addEventListener('scroll', () => {
        const currentScroll = window.pageYOffset;
        
        if (currentScroll <= 0) {
            header.classList.remove('hidden');
            return;
        }
        
        if (currentScroll > lastScroll && !header.classList.contains('hidden')) {
            header.classList.add('hidden');
        } else if (currentScroll < lastScroll && header.classList.contains('hidden')) {
            header.classList.remove('hidden');
        }
        
        lastScroll = currentScroll;
    });
}

async function handleSearch() {
    const searchInput = document.getElementById('searchInput');
    if (!searchInput) return;
    
    const query = searchInput.value.trim();
    
    if (query) {
        showNotification(`Searching for: ${query}`, 'info');
        if (state.soundEffects) state.soundEffects.play('notification');
        await loadVideos(true, query);
    } else {
        showNotification('Please enter a search term', 'info');
        if (state.animationController) state.animationController.shakeElement(searchInput);
    }
}

function handleHomeClick() {
    if (state.soundEffects) state.soundEffects.play('click');
    if (state.animationController) state.animationController.pulseElement(document.getElementById('homeBtn'));
    
    const uploadSection = document.getElementById('uploadSection');
    const videosSection = document.getElementById('videosSection');
    const searchInput = document.getElementById('searchInput');
    const sortVideos = document.getElementById('sortVideos');
    
    if (uploadSection) uploadSection.style.display = 'none';
    if (videosSection) videosSection.style.display = 'block';
    if (searchInput) searchInput.value = '';
    if (sortVideos) sortVideos.value = 'newest';
    
    loadVideos(true);
    
    document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('active');
    });
    const homeBtn = document.getElementById('homeBtn');
    if (homeBtn) homeBtn.classList.add('active');
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function loadCurrentUser() {
    try {
        const res = await fetch('/api/me', { credentials: 'include' });
        if (res.ok) {
            const data = await res.json();
            if (data.authenticated) {
                state.currentUser = data.user;
                updateUserUI();
            }
        }
    } catch (err) {
        console.error('Failed to load user:', err);
    }
}

function updateUserUI() {
    if (state.currentUser) {
        const avatarUrl = state.currentUser.avatar_url || state.currentUser.profile_picture || 
            `https://ui-avatars.com/api/?name=${encodeURIComponent(state.currentUser.username || state.currentUser.email)}&background=random`;
        
        const userAvatar = document.getElementById('userAvatar');
        const commentAvatar = document.getElementById('commentAvatar');
        const dropdownHeader = document.getElementById('dropdownHeader');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginBtn = document.getElementById('loginBtn');
        const commentInput = document.getElementById('commentInput');
        const commentSubmitBtn = document.getElementById('commentSubmitBtn');
        
        if (userAvatar) userAvatar.src = avatarUrl;
        if (commentAvatar) commentAvatar.src = avatarUrl;
        
        if (dropdownHeader) {
            dropdownHeader.innerHTML = `
                <h3>${state.currentUser.username || state.currentUser.email}</h3>
                <p>${state.currentUser.email}</p>
            `;
        }
        
        if (logoutBtn) logoutBtn.style.display = 'block';
        if (loginBtn) loginBtn.style.display = 'none';
        
        if (commentInput) commentInput.placeholder = "Add a comment...";
        if (commentSubmitBtn) commentSubmitBtn.disabled = false;
    } else {
        const logoutBtn = document.getElementById('logoutBtn');
        const loginBtn = document.getElementById('loginBtn');
        const commentInput = document.getElementById('commentInput');
        const commentSubmitBtn = document.getElementById('commentSubmitBtn');
        
        if (logoutBtn) logoutBtn.style.display = 'none';
        if (loginBtn) loginBtn.style.display = 'block';
        
        if (commentInput) commentInput.placeholder = "Sign in to comment";
        if (commentSubmitBtn) commentSubmitBtn.disabled = true;
    }
}

async function logout() {
    try {
        const res = await fetch('/api/logout', {
            method: 'POST',
            credentials: 'include'
        });
        
        if (res.ok) {
            state.currentUser = null;
            const userDropdown = document.getElementById('userDropdown');
            if (userDropdown) userDropdown.classList.remove('show');
            updateUserUI();
            showNotification('Logged out successfully', 'success');
            if (state.soundEffects) state.soundEffects.play('success');
            loadVideos(true);
        }
    } catch (err) {
        showNotification('Logout failed', 'error');
        if (state.soundEffects) state.soundEffects.play('error');
    }
}

function setupUploadHandlers() {
    const uploadArea = document.getElementById('uploadArea');
    const videoFileInput = document.getElementById('videoFile');
    const selectFileBtn = document.getElementById('selectFileBtn');
    const clearFileBtn = document.getElementById('clearFileBtn');
    const uploadForm = document.getElementById('uploadForm');
    
    if (!uploadArea || !videoFileInput || !selectFileBtn || !clearFileBtn || !uploadForm) return;
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleVideoSelect(files[0]);
        }
    });
    
    selectFileBtn.addEventListener('click', () => {
        videoFileInput.click();
    });
    
    videoFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleVideoSelect(e.target.files[0]);
        }
    });
    
    clearFileBtn.addEventListener('click', () => {
        videoFileInput.value = '';
        const fileInfo = document.getElementById('fileInfo');
        if (fileInfo) fileInfo.style.display = 'none';
        showNotification('File cleared', 'info');
        if (state.soundEffects) state.soundEffects.play('click');
    });
    
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        await handleUpload();
    });
}

function handleVideoSelect(file) {
    if (!file.type.startsWith('video/')) {
        showNotification('Please select a video file', 'error');
        if (state.soundEffects) state.soundEffects.play('error');
        return;
    }
    
    if (file.size > 500 * 1024 * 1024) {
        showNotification('File size must be less than 500MB', 'error');
        if (state.soundEffects) state.soundEffects.play('error');
        return;
    }
    
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    
    if (fileInfo && fileName && fileSize) {
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.style.display = 'block';
    }
    
    showNotification('Video file selected', 'success');
    if (state.soundEffects) state.soundEffects.play('success');
}

async function handleUpload() {
    if (!state.currentUser) {
        showNotification('Please sign in to upload videos', 'error');
        if (state.soundEffects) state.soundEffects.play('error');
        return;
    }
    
    const videoFileInput = document.getElementById('videoFile');
    const videoTitle = document.getElementById('videoTitle');
    
    if (!videoFileInput || !videoTitle) return;
    
    const videoFile = videoFileInput.files[0];
    const title = videoTitle.value.trim();
    
    if (!videoFile) {
        showNotification('Please select a video file', 'error');
        if (state.soundEffects) state.soundEffects.play('error');
        return;
    }
    
    if (!title) {
        showNotification('Please enter a video title', 'error');
        if (state.soundEffects) state.soundEffects.play('error');
        return;
    }
    
    const formData = new FormData();
    formData.append('video', videoFile);
    formData.append('title', title);
    
    const videoDescription = document.getElementById('videoDescription');
    const videoCategory = document.getElementById('videoCategory');
    const videoPrivacy = document.getElementById('videoPrivacy');
    const videoTags = document.getElementById('videoTags');
    const allowComments = document.getElementById('allowComments');
    const allowRatings = document.getElementById('allowRatings');
    const showViewCount = document.getElementById('showViewCount');
    const aiGenerated = document.getElementById('aiGenerated');
    
    if (videoDescription) formData.append('description', videoDescription.value.trim());
    if (videoCategory) formData.append('category', videoCategory.value);
    if (videoPrivacy) formData.append('privacy', videoPrivacy.value);
    if (videoTags) formData.append('tags', videoTags.value);
    
    const settings = {};
    if (allowComments) settings.allowComments = allowComments.checked;
    if (allowRatings) settings.allowRatings = allowRatings.checked;
    if (showViewCount) settings.showViewCount = showViewCount.checked;
    if (aiGenerated) settings.aiGenerated = aiGenerated.checked;
    
    formData.append('settings', JSON.stringify(settings));
    
    try {
        showNotification('Uploading video...', 'info');
        if (state.soundEffects) state.soundEffects.play('upload');
        
        const response = await fetch('/api/upload-video', {
            method: 'POST',
            body: formData,
            credentials: 'include'
        });
        
        if (response.ok) {
            const result = await response.json();
            showNotification('Video uploaded successfully!', 'success');
            if (state.soundEffects) state.soundEffects.play('success');
            closeUploadModal();
            const fileInfo = document.getElementById('fileInfo');
            if (fileInfo) fileInfo.style.display = 'none';
            const uploadForm = document.getElementById('uploadForm');
            if (uploadForm) uploadForm.reset();
            loadVideos(true);
        } else {
            const error = await response.text();
            showNotification(`Upload failed: ${error}`, 'error');
            if (state.soundEffects) state.soundEffects.play('error');
        }
    } catch (error) {
        showNotification(`Upload error: ${error.message}`, 'error');
        if (state.soundEffects) state.soundEffects.play('error');
    }
}

function closeUploadModal() {
    const uploadSection = document.getElementById('uploadSection');
    const videosSection = document.getElementById('videosSection');
    
    if (uploadSection) uploadSection.style.display = 'none';
    if (videosSection) videosSection.style.display = 'block';
    
    handleHomeClick();
}

function formatNumber(num) {
    if (!num) return '0';
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString();
}

function formatDuration(seconds) {
    if (!seconds) return '--:--';
    const hrs = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hrs > 0) {
        return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function formatRelativeTime(dateString) {
    if (!dateString) return 'Recently';
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
    return date.toLocaleDateString();
}

function formatFileSize(bytes) {
    if (!bytes) return '0 B';
    if (bytes >= 1000000000) {
        return (bytes / 1000000000).toFixed(1) + ' GB';
    } else if (bytes >= 1000000) {
        return (bytes / 1000000).toFixed(1) + ' MB';
    } else if (bytes >= 1000) {
        return (bytes / 1000).toFixed(1) + ' KB';
    }
    return bytes + ' B';
}

async function loadVideos(reset = false, searchQuery = '') {
    const activeTab = document.querySelector('.sidebar-item.active');
    let viewType = 'home';
    
    if (activeTab) {
        const tabMap = {
            'homeBtn': 'home',
            'trendingBtn': 'trending',
            'historyBtn': 'history',
            'likedBtn': 'liked',
            'yourVideosBtn': 'your-videos',
            'watchLaterBtn': 'watch-later'
        };
        
        viewType = tabMap[activeTab.id] || 'home';
    }
    
    await loadVideosForView(viewType, reset, searchQuery);
}

async function loadVideosForView(viewType, reset = true, searchQuery = '') {
    const videosList = document.getElementById('videosList');
    if (!videosList) return;
    
    if (reset) {
        state.displayedVideos = 0;
        videosList.innerHTML = `
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading ${viewType} videos...</p>
            </div>
        `;
    }
    
    try {
        const sortBy = document.getElementById('sortVideos')?.value || 'newest';
        let url = `/api/view-videos?view=${viewType}&sort=${sortBy}&limit=${VIDEOS_PER_PAGE}&offset=${state.displayedVideos}`;
        
        if (searchQuery) {
            const encodedTerm = encodeURIComponent(searchQuery);
            url = `/api/view-videos?or=(title.ilike.%25${encodedTerm}%25,description.ilike.%25${encodedTerm}%25,users.username.ilike.%25${encodedTerm}%25)&limit=${VIDEOS_PER_PAGE}&offset=${state.displayedVideos}`;
        }
        
        const response = await fetch(url, { credentials: 'include' });
        
        if (!response.ok) {
            if (response.status === 401) {
                const errorData = await response.json();
                videosList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-lock"></i>
                        <h3>Authentication Required</h3>
                        <p>${errorData.error || 'Please sign in to view this content'}</p>
                        <button class="btn-primary" onclick="window.location.href='/login'" style="margin-top: 16px;">
                            <i class="fas fa-sign-in-alt"></i>
                            Sign In
                        </button>
                    </div>
                `;
                return;
            }
            
            throw new Error(`Failed to load videos: ${response.status}`);
        }
        
        const videos = await response.json();
        
        if (reset) {
            state.videosCache = videos;
        } else {
            state.videosCache = [...state.videosCache, ...videos];
        }
        
        if (videos.length === 0) {
            if (reset) {
                const emptyMessages = {
                    'home': 'No videos found. Be the first to upload!',
                    'trending': 'No trending videos yet',
                    'history': 'No watch history found',
                    'liked': 'No liked videos yet',
                    'your-videos': 'You haven\'t uploaded any videos yet',
                    'watch-later': 'No videos in watch later'
                };
                
                videosList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-video-slash"></i>
                        <h3>No videos found</h3>
                        <p>${emptyMessages[viewType] || 'Try a different view or upload a video'}</p>
                        ${viewType === 'your-videos' ? `
                            <button class="btn-primary" id="uploadFromEmptyBtn" style="margin-top: 16px;">
                                <i class="fas fa-upload"></i>
                                Upload Your First Video
                            </button>
                        ` : ''}
                    </div>
                `;
                
                if (viewType === 'your-videos') {
                    const uploadFromEmptyBtn = document.getElementById('uploadFromEmptyBtn');
                    if (uploadFromEmptyBtn) {
                        uploadFromEmptyBtn.addEventListener('click', () => {
                            const uploadBtn = document.getElementById('uploadBtn');
                            if (uploadBtn) uploadBtn.click();
                        });
                    }
                }
            }
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            if (loadMoreContainer) loadMoreContainer.style.display = 'none';
            return;
        }
        
        renderVideos(videos, reset);
        state.displayedVideos += videos.length;
        
        const loadMoreContainer = document.getElementById('loadMoreContainer');
        if (loadMoreContainer) {
            loadMoreContainer.style.display = 
                videos.length === VIDEOS_PER_PAGE ? 'block' : 'none';
        }
        
        if (!state.pollingInterval) {
            startRealTimePolling();
        }
        
    } catch (error) {
        console.error(`Load ${viewType} videos error:`, error);
        showNotification(`Failed to load ${viewType} videos: ${error.message}`, 'error');
        if (state.soundEffects) state.soundEffects.play('error');
        videosList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Failed to load videos</h3>
                <p>Please try again later</p>
            </div>
        `;
    }
}

function renderVideos(videos, reset = false) {
    const videosList = document.getElementById('videosList');
    if (!videosList) return;
    
    if (reset) videosList.innerHTML = '';
    
    videos.forEach(video => {
        const videoCard = document.createElement('div');
        videoCard.className = 'video-card parallax-card';
        videoCard.setAttribute('data-video-id', video.id);
        
        const thumbnail = video.cover_url || 'https://images.unsplash.com/photo-1611605698335-8b1569810435?w=800&h=450&fit=crop';
        const duration = video.duration ? formatDuration(video.duration) : '--:--';
        const views = video.views ? formatNumber(video.views) : '0';
        const uploadTime = video.uploaded_at ? formatRelativeTime(video.uploaded_at) : 
                          (video.created_at ? formatRelativeTime(video.created_at) : 'Recently');
        
        const userAvatar = video.user?.avatar_url || video.user?.profile_picture || 
            `https://ui-avatars.com/api/?name=${encodeURIComponent(video.user?.username || video.user?.email || 'User')}&background=random`;
        
        const aiBadge = video.ai_generated ? '<span class="ai-badge"><i class="fas fa-robot"></i> AI</span>' : '';
        
        videoCard.innerHTML = `
            <div class="video-thumbnail">
                <img src="${thumbnail}" alt="${video.title || 'Video'}" 
                     onerror="this.src='https://images.unsplash.com/photo-1611605698335-8b1569810435?w=800&h=450&fit=crop'">
                <span class="video-duration">${duration}</span>
            </div>
            <div class="video-info">
                <img src="${userAvatar}" 
                     alt="${video.user?.username || 'User'}" 
                     class="channel-avatar"
                     onerror="this.src='https://ui-avatars.com/api/?name=User&background=random'">
                <div class="video-content">
                    <h3 class="video-title">${video.title || 'Untitled Video'}</h3>
                    <p class="channel-name">${video.user?.username || video.user?.email?.split('@')[0] || 'User'}</p>
                    <div class="video-stats">
                        <span>${views} views</span>
                        
                        <span>${uploadTime}</span>
                        ${aiBadge}
                    </div>
                </div>
            </div>
        `;
        
        videoCard.addEventListener('click', () => openVideoModal(video));
        videoCard.style.animationDelay = `${Math.random() * 0.3}s`;
        
        videosList.appendChild(videoCard);
    });
}

async function openVideoModal(video) {
    state.currentVideo = video;
    const modal = document.getElementById('videoModal');
    const player = document.getElementById('modalVideo');
    
    if (!modal || !player) return;
    
    if (video.video_url) {
        player.src = video.video_url;
    }
    
    if (video.cover_url) {
        player.poster = video.cover_url;
    }
    
    const modalVideoTitle = document.getElementById('modalVideoTitle');
    const modalVideoMeta = document.getElementById('modalVideoMeta');
    const likeCount = document.getElementById('likeCount');
    
    if (modalVideoTitle) modalVideoTitle.textContent = video.title || 'Untitled Video';
    
    const uploadTime = video.uploaded_at || video.created_at;
    const aiBadge = video.ai_generated ? ' <span class="ai-badge"><i class="fas fa-robot"></i> AI Generated</span>' : '';
    if (modalVideoMeta) {
        modalVideoMeta.innerHTML = `
            <span>${formatNumber(video.views || 0)} views</span>
            
            <span>${uploadTime ? formatRelativeTime(uploadTime) : 'Recently'}</span>
            ${aiBadge}
        `;
    }
    
    const descShort = document.getElementById('videoDescriptionShort');
    const descFull = document.getElementById('videoDescriptionFull');
    const toggleBtn = document.getElementById('descriptionToggleBtn');
    
    if (video.description && descShort && descFull && toggleBtn) {
        const shortText = video.description.substring(0, 200);
        descShort.textContent = shortText;
        descFull.textContent = video.description;
        
        if (video.description.length > 200) {
            toggleBtn.style.display = 'inline-block';
            toggleBtn.textContent = 'Show more';
            toggleBtn.onclick = toggleDescription;
        } else {
            toggleBtn.style.display = 'none';
        }
    } else if (descShort) {
        descShort.textContent = 'No description provided';
        if (descFull) descFull.textContent = '';
        if (toggleBtn) toggleBtn.style.display = 'none';
    }
    
    if (state.currentUser) {
        updateLikeButton({
            likes: video.likes || 0,
            liked: video.hasLiked || false
        });
    } else {
        updateLikeButton({
            likes: video.likes || 0,
            liked: false
        });
    }
    
    if (likeCount) likeCount.textContent = formatNumber(video.likes || 0);
    
    await loadComments(true, video.comments || []);
    await loadRecommendedVideos();
    
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Show avatar overlay if enabled
    if (state.avatarInVideo) {
        const overlay = document.getElementById('avatarOverlay');
        if (overlay) overlay.classList.add('visible');
        state.avatarVisible = true;
    }
    
    player.play().catch((error) => {
        console.log('Video play failed:', error.message);
        showNotification('Click play to start video', 'info');
        if (state.soundEffects) state.soundEffects.play('notification');
    });
    
    await trackView(video.id);
}

function closeVideoModal() {
    const modal = document.getElementById('videoModal');
    const player = document.getElementById('modalVideo');
    
    if (player) {
        player.pause();
        player.src = '';
        player.poster = '';
    }
    
    if (modal) modal.classList.remove('show');
    
    document.body.style.overflow = '';
    state.currentVideo = null;
    
    // Hide avatar overlay
    hideAvatarOverlay();
}

function toggleDescription() {
    const short = document.getElementById('videoDescriptionShort');
    const full = document.getElementById('videoDescriptionFull');
    const toggleBtn = document.getElementById('descriptionToggleBtn');
    
    if (!short || !full || !toggleBtn) return;
    
    if (full.style.display === 'none') {
        short.style.display = 'none';
        full.style.display = 'block';
        toggleBtn.textContent = 'Show less';
    } else {
        short.style.display = 'block';
        full.style.display = 'none';
        toggleBtn.textContent = 'Show more';
    }
}

async function loadComments(reset = false, videoComments = null) {
    if (!state.currentVideo && !videoComments) return;
    
    const commentsList = document.getElementById('commentsList');
    if (!commentsList) return;
    
    if (reset) {
        state.commentsCache[state.currentVideo.id] = { comments: [], page: 0, total: 0 };
        commentsList.innerHTML = `
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading comments...</p>
            </div>
        `;
    }
    
    try {
        const comments = videoComments || state.currentVideo.comments || [];
        
        const commentsCount = document.getElementById('commentsCount');
        if (commentsCount) {
            commentsCount.textContent = `${formatNumber(comments.length)} Comments`;
        }
        
        if (comments.length === 0 && reset) {
            commentsList.innerHTML = `
                <div style="text-align: center; padding: 48px; color: var(--text-tertiary);">
                    <i class="fas fa-comment-slash" style="font-size: 24px; margin-bottom: 16px;"></i>
                    <h3>No comments yet</h3>
                    <p>Be the first to comment!</p>
                </div>
            `;
            const loadMoreComments = document.getElementById('loadMoreComments');
            if (loadMoreComments) loadMoreComments.style.display = 'none';
            return;
        }
        
        renderComments(comments, reset);
        const loadMoreComments = document.getElementById('loadMoreComments');
        if (loadMoreComments) loadMoreComments.style.display = 'none';
        
    } catch (error) {
        console.error('Load comments error:', error);
        showNotification(`Failed to load comments: ${error.message}`, 'error');
        if (state.soundEffects) state.soundEffects.play('error');
        commentsList.innerHTML = `
            <div style="text-align: center; padding: 48px; color: var(--text-tertiary);">
                <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 16px;"></i>
                <h3>Failed to load comments</h3>
            </div>
        `;
    }
}

function renderComments(comments, reset = false) {
    const commentsList = document.getElementById('commentsList');
    if (!commentsList) return;
    
    if (reset) commentsList.innerHTML = '';
    
    comments.forEach((comment, index) => {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'comment-item';
        commentDiv.setAttribute('data-comment-id', comment.id);
        
        const userAvatar = comment.user?.avatar_url || comment.user?.profile_picture || 
            `https://ui-avatars.com/api/?name=${encodeURIComponent(comment.user?.username || comment.user?.email || 'User')}&background=random`;
        
        commentDiv.innerHTML = `
            <img src="${userAvatar}" alt="${comment.user?.username || 'User'}" 
                 class="comment-avatar"
                 onerror="this.src='https://ui-avatars.com/api/?name=User&background=random'">
            <div class="comment-content">
                <div class="comment-header">
                    <span class="comment-author">${comment.user?.username || 'User'}</span>
                    <span class="comment-time">${formatRelativeTime(comment.created_at)}</span>
                </div>
                <div class="comment-text">${comment.text || ''}</div>
                <div class="comment-actions">
                    <button class="comment-like" onclick="likeComment('${comment.id}', ${comment.hasLiked || false})">
                        <i class="${comment.hasLiked ? 'fas' : 'far'} fa-thumbs-up"></i>
                        <span>${formatNumber(comment.likes || 0)}</span>
                    </button>
                    <button class="comment-reply">
                        Reply
                    </button>
                </div>
            </div>
        `;
        
        commentDiv.style.animationDelay = `${index * 0.1}s`;
        commentsList.appendChild(commentDiv);
    });
}

async function toggleLike() {
    if (!state.currentVideo || !state.currentUser) {
        showNotification('Please sign in to like videos', 'error');
        if (state.soundEffects) state.soundEffects.play('error');
        return;
    }
    
    if (state.soundEffects) state.soundEffects.play('click');
    if (state.animationController) state.animationController.pulseElement(document.getElementById('likeBtn'));
    
    try {
        const response = await fetch('/api/like-video', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                videoId: state.currentVideo.id,
                action: state.currentVideo.hasLiked ? 'unlike' : 'like'
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            state.currentVideo.hasLiked = data.liked;
            state.currentVideo.likes = data.likes;
            updateLikeButton(data);
            showNotification(data.liked ? 'Video liked!' : 'Video unliked', 'success');
            if (state.soundEffects) state.soundEffects.play(data.liked ? 'success' : 'click');
        }
    } catch (error) {
        showNotification('Failed to update like', 'error');
        if (state.soundEffects) state.soundEffects.play('error');
    }
}

function updateLikeButton(data) {
    const likeBtn = document.getElementById('likeBtn');
    const likeCount = document.getElementById('likeCount');
    
    if (!likeBtn || !likeCount) return;
    
    likeCount.textContent = formatNumber(data.likes || 0);
    
    if (data.liked) {
        likeBtn.innerHTML = `<i class="fas fa-thumbs-up"></i> <span id="likeCount">${likeCount.textContent}</span>`;
        likeBtn.classList.add('liked');
    } else {
        likeBtn.innerHTML = `<i class="far fa-thumbs-up"></i> <span id="likeCount">${likeCount.textContent}</span>`;
        likeBtn.classList.remove('liked');
    }
}

async function postComment() {
    if (!state.currentVideo || !state.currentUser) {
        showNotification('Please sign in to comment', 'error');
        if (state.soundEffects) state.soundEffects.play('error');
        return;
    }
    
    const commentInput = document.getElementById('commentInput');
    if (!commentInput) return;
    
    const text = commentInput.value.trim();
    
    if (!text) {
        showNotification('Comment cannot be empty', 'error');
        if (state.soundEffects) state.soundEffects.play('error');
        return;
    }
    
    if (state.soundEffects) state.soundEffects.play('click');
    
    try {
        const response = await fetch(`/api/view-videos?videoId=${state.currentVideo.id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ text })
        });
        
        if (response.ok) {
            const comment = await response.json();
            commentInput.value = '';
            
            const commentsList = document.getElementById('commentsList');
            if (!commentsList) return;
            
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment-item';
            commentDiv.setAttribute('data-comment-id', comment.id);
            
            const userAvatar = state.currentUser.avatar_url || state.currentUser.profile_picture || 
                `https://ui-avatars.com/api/?name=${encodeURIComponent(state.currentUser.username || state.currentUser.email)}&background=random`;
            
            commentDiv.innerHTML = `
                <img src="${userAvatar}" alt="${state.currentUser.username || 'User'}" class="comment-avatar">
                <div class="comment-content">
                    <div class="comment-header">
                        <span class="comment-author">${state.currentUser.username || 'User'}</span>
                        <span class="comment-time">Just now</span>
                    </div>
                    <div class="comment-text">${text}</div>
                    <div class="comment-actions">
                        <button class="comment-like">
                            <i class="far fa-thumbs-up"></i>
                            <span>0</span>
                        </button>
                        <button class="comment-reply">
                            Reply
                        </button>
                    </div>
                </div>
            `;
            
            commentsList.insertBefore(commentDiv, commentsList.firstChild);
            
            const commentsCount = document.getElementById('commentsCount');
            if (commentsCount) {
                const currentCount = parseInt(commentsCount.textContent) || 0;
                commentsCount.textContent = `${formatNumber(currentCount + 1)} Comments`;
            }
            
            showNotification('Comment posted!', 'success');
            if (state.soundEffects) state.soundEffects.play('success');
        }
    } catch (error) {
        showNotification('Failed to post comment', 'error');
        if (state.soundEffects) state.soundEffects.play('error');
    }
}

async function likeComment(commentId, isLiked) {
    if (!state.currentUser) {
        showNotification('Please sign in to like comments', 'error');
        if (state.soundEffects) state.soundEffects.play('error');
        return;
    }
    
    if (state.soundEffects) state.soundEffects.play('click');
    
    try {
        const response = await fetch(`/api/like-video`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                commentId: commentId,
                action: isLiked ? 'unlike' : 'like'
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            const commentDiv = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
            if (commentDiv) {
                const likeBtn = commentDiv.querySelector('.comment-like');
                const likeCount = commentDiv.querySelector('.comment-like span');
                
                if (likeBtn && likeCount) {
                    likeBtn.classList.toggle('liked', data.liked);
                    likeBtn.innerHTML = `<i class="${data.liked ? 'fas' : 'far'} fa-thumbs-up"></i> <span>${formatNumber(data.likes)}</span>`;
                    if (state.animationController) state.animationController.pulseElement(likeBtn);
                }
            }
        }
    } catch (error) {
        showNotification('Failed to like comment', 'error');
        if (state.soundEffects) state.soundEffects.play('error');
    }
}

async function loadRecommendedVideos() {
    const recommendedVideos = document.getElementById('recommendedVideos');
    if (!recommendedVideos) return;
    
    recommendedVideos.innerHTML = `
        <div style="text-align: center; padding: 20px; color: var(--text-tertiary);">
            <p>Recommended videos will appear here</p>
        </div>
    `;
}

async function trackView(videoId) {
    try {
        await fetch(`/api/view-videos?videoId=${videoId}&incrementViews=true`, {
            method: 'GET',
            credentials: 'include'
        });
    } catch (error) {
        console.error('Failed to track view:', error);
    }
}

function openSettings() {
    showNotification('Settings feature coming soon!', 'info');
    if (state.soundEffects) state.soundEffects.play('notification');
}

function shareVideo() {
    if (navigator.share) {
        navigator.share({
            title: state.currentVideo?.title || 'Check out this video',
            text: 'Watch this video on Vibro.x',
            url: window.location.href
        });
    } else {
        navigator.clipboard.writeText(window.location.href).then(() => {
            showNotification('Link copied to clipboard!', 'success');
            if (state.soundEffects) state.soundEffects.play('success');
        }).catch(() => {
            showNotification('Failed to copy link', 'error');
            if (state.soundEffects) state.soundEffects.play('error');
        });
    }
}

function setupTabHandlers() {
    const tabs = {
        'homeBtn': 'home',
        'trendingBtn': 'trending',
        'historyBtn': 'history',
        'likedBtn': 'liked',
        'yourVideosBtn': 'your-videos',
        'watchLaterBtn': 'watch-later'
    };
    
    Object.entries(tabs).forEach(([tabId, viewType]) => {
        const tab = document.getElementById(tabId);
        if (tab) {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                handleTabClick(tabId, viewType);
            });
        }
    });
    
    // Additional sidebar items
    const avatarsBtn = document.getElementById('avatarsBtn');
    const effectsBtn = document.getElementById('effectsBtn');
    const physicsBtn = document.getElementById('physicsBtn');
    const soundBtn = document.getElementById('soundBtn');
    
    if (avatarsBtn) {
        avatarsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('customizationPanel').classList.add('active');
            createParticleBurst(20, 'avatar');
        });
    }
    
    if (effectsBtn) {
        effectsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('customizationPanel').classList.add('active');
            createParticleBurst(20, 'effect');
        });
    }
    
    if (physicsBtn) {
        physicsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('customizationPanel').classList.add('active');
            createParticleBurst(20, 'physics');
        });
    }
    
    if (soundBtn) {
        soundBtn.addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('customizationPanel').classList.add('active');
            playSound('click');
        });
    }
}

async function handleTabClick(tabId, viewType) {
    if (state.soundEffects) state.soundEffects.play('click');
    if (state.animationController) state.animationController.pulseElement(document.getElementById(tabId));
    
    document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('active');
    });
    const tab = document.getElementById(tabId);
    if (tab) tab.classList.add('active');
    
    const uploadSection = document.getElementById('uploadSection');
    const videosSection = document.getElementById('videosSection');
    const searchInput = document.getElementById('searchInput');
    
    if (uploadSection) uploadSection.style.display = 'none';
    if (videosSection) videosSection.style.display = 'block';
    if (searchInput) searchInput.value = '';
    
    const pageTitles = {
        'home': 'Recommended Videos',
        'trending': 'Trending Videos',
        'history': 'Watch History',
        'liked': 'Liked Videos',
        'your-videos': 'Your Videos',
        'watch-later': 'Watch Later'
    };
    
    const videosSectionHeading = document.querySelector('#videosSection h2');
    if (videosSectionHeading) {
        videosSectionHeading.textContent = pageTitles[viewType] || 'Videos';
    }
    
    await loadVideosForView(viewType);
}

function startRealTimePolling() {
    if (state.pollingInterval) clearInterval(state.pollingInterval);
    
    state.pollingInterval = setInterval(async () => {
        if (!state.videosCache || state.videosCache.length === 0) return;
        
        try {
            const videoIds = state.videosCache.map(v => v.id).join(',');
            const response = await fetch(
                `/api/view-videos?statsOnly=true&ids=${videoIds}&since=${state.lastUpdateCheck}`,
                { credentials: 'include' }
            );
            
            if (response.ok) {
                const updates = await response.json();
                if (updates && updates.length > 0) {
                    updates.forEach(update => {
                        updateVideoStatsInUI(update);
                    });
                }
                state.lastUpdateCheck = Date.now();
            }
        } catch (err) {
            console.error('Polling error:', err);
        }
    }, POLLING_INTERVAL);
}

function updateVideoStatsInUI(stats) {
    const videoElement = document.querySelector(`.video-card[data-video-id="${stats.id}"]`);
    if (!videoElement) return;
    
    const viewsElement = videoElement.querySelector('.video-stats span:first-child');
    if (viewsElement && stats.views !== undefined) {
        viewsElement.textContent = `${formatNumber(stats.views)} views`;
    }
}

// Clean up
window.addEventListener('beforeunload', () => {
    if (state.pollingInterval) clearInterval(state.pollingInterval);
    if (state.animationController && state.animationController.observer) {
        state.animationController.observer.disconnect();
    }
});

// Additional event listeners for combined features
document.addEventListener('click', (e) => {
    // Handle clicks for sound
    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
        playSound('click');
    }
});

// Mobile menu toggle
const mobileMenuToggle = document.getElementById('mobileMenuToggle');
if (mobileMenuToggle) {
    mobileMenuToggle.addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('visible');
        playSound('click');
    });
}

// Mobile search toggle
const searchToggle = document.getElementById('searchToggle');
if (searchToggle) {
    searchToggle.addEventListener('click', () => {
        document.getElementById('searchBar').classList.toggle('mobile-visible');
        playSound('click');
    });
}

// Logo click
const logoBtn = document.getElementById('logoBtn');
if (logoBtn) {
    logoBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (state.animationController) state.animationController.pulseElement(e.target);
        if (state.soundEffects) state.soundEffects.play('click');
        handleHomeClick();
    });
}

// Search button
const searchButton = document.getElementById('searchButton');
if (searchButton) {
    searchButton.addEventListener('click', () => {
        if (state.animationController) state.animationController.shakeElement(document.getElementById('searchBar'));
        if (state.soundEffects) state.soundEffects.play('click');
        handleSearch();
    });
}

// Upload button
const uploadBtn = document.getElementById('uploadBtn');
if (uploadBtn) {
    uploadBtn.addEventListener('click', () => {
        if (state.soundEffects) state.soundEffects.play('upload');
        const uploadSection = document.getElementById('uploadSection');
        const videosSection = document.getElementById('videosSection');
        
        if (uploadSection) uploadSection.style.display = 'block';
        if (videosSection) videosSection.style.display = 'none';
        
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.classList.remove('active');
        });
    });
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    // Space to play/pause video
    if (e.code === 'Space' && document.getElementById('videoModal')?.classList.contains('show')) {
        e.preventDefault();
        const video = document.getElementById('modalVideo');
        if (video) {
            video.paused ? video.play() : video.pause();
            playSound('click');
        }
    }
    
    // Escape to close modals
    if (e.code === 'Escape') {
        if (document.getElementById('videoModal')?.classList.contains('show')) {
            closeVideoModal();
            playSound('click');
        }
        if (document.getElementById('uploadSection')?.style.display !== 'none') {
            closeUploadModal();
            playSound('click');
        }
        if (document.getElementById('customizationPanel')?.classList.contains('active')) {
            document.getElementById('customizationPanel').classList.remove('active');
            playSound('click');
        }
    }
    
    // / to focus search
    if (e.code === 'Slash' && !e.target.matches('input, textarea')) {
        e.preventDefault();
        const searchInput = document.getElementById('searchInput');
        if (searchInput) searchInput.focus();
        playSound('hover');
    }
    
    // Theme cycling with T
    if (e.code === 'KeyT' && e.ctrlKey) {
        e.preventDefault();
        if (state.themeManager) state.themeManager.cycleTheme();
        playSound('notification');
    }
});

// Add parallax effect
window.addEventListener('mousemove', (e) => {
    const gradientBg = document.querySelector('.gradient-bg');
    if (!gradientBg) return;
    
    const x = (window.innerWidth - e.pageX * 2) / 100;
    const y = (window.innerHeight - e.pageY * 2) / 100;
    
    gradientBg.style.transform = 
        `translate(${x}px, ${y}px) rotate(${x}deg)`;
});

// Add scroll effects
window.addEventListener('scroll', () => {
    const scrolled = window.pageYOffset;
    const header = document.querySelector('.header');
    
    if (header) {
        if (scrolled > 50) {
            header.classList.add('scrolled');
        } else {
            header.classList.remove('scrolled');
        }
    }
    
    document.querySelectorAll('.floating-element').forEach((el, i) => {
        const speed = 0.5 + (i * 0.1);
        el.style.transform = `translateY(${scrolled * speed}px)`;
    });
});

// Continuous background animation
setInterval(() => {
    const elements = document.querySelectorAll('.floating-element');
    if (elements.length > 0) {
        const randomEl = elements[Math.floor(Math.random() * elements.length)];
        randomEl.style.animation = 'pulseEffect 2s ease-in-out';
        setTimeout(() => {
            randomEl.style.animation = '';
        }, 2000);
    }
}, 3000);
</script>
</body>
</html>
